<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Android Log," />





  <link rel="alternate" href="/atom.xml" title="EricChows" type="application/atom+xml" />






<meta name="description" content="Android 解读main log和event log日志信息https://blog.csdn.net/yelangjueqi/article/details/52621903 Log中’main’, ‘system’, ‘radio’, ‘events’以及android log分析https://www.cnblogs.com/zhengtu2015/p/5134012.html 关于An">
<meta name="keywords" content="Android Log">
<meta property="og:type" content="article">
<meta property="og:title" content="Android的Log机制分析">
<meta property="og:url" content="http://yoursite.com/Android-Log-Analysis/index.html">
<meta property="og:site_name" content="EricChows">
<meta property="og:description" content="Android 解读main log和event log日志信息https://blog.csdn.net/yelangjueqi/article/details/52621903 Log中’main’, ‘system’, ‘radio’, ‘events’以及android log分析https://www.cnblogs.com/zhengtu2015/p/5134012.html 关于An">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-07-18T08:55:48.809Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android的Log机制分析">
<meta name="twitter:description" content="Android 解读main log和event log日志信息https://blog.csdn.net/yelangjueqi/article/details/52621903 Log中’main’, ‘system’, ‘radio’, ‘events’以及android log分析https://www.cnblogs.com/zhengtu2015/p/5134012.html 关于An">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/Android-Log-Analysis/"/>





  <title>Android的Log机制分析 | EricChows</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">EricChows</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Android Developer</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/Android-Log-Analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Eric Chows">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myapple.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="EricChows">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Android的Log机制分析</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-27T23:45:18+08:00">
                2018-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/Android-Log-Analysis/" class="leancloud_visitors" data-flag-title="Android的Log机制分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Android 解读main log和event log日志信息<br><a href="https://blog.csdn.net/yelangjueqi/article/details/52621903" target="_blank" rel="noopener">https://blog.csdn.net/yelangjueqi/article/details/52621903</a></p>
<p>Log中’main’, ‘system’, ‘radio’, ‘events’以及android log分析<br><a href="https://www.cnblogs.com/zhengtu2015/p/5134012.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhengtu2015/p/5134012.html</a></p>
<p>关于Android Log的一些思考<br><a href="https://droidyue.com/blog/2015/11/01/thinking-about-android-log/" target="_blank" rel="noopener">https://droidyue.com/blog/2015/11/01/thinking-about-android-log/</a></p>
<p><a href="https://blog.csdn.net/fishmai/article/details/52398537" target="_blank" rel="noopener">https://blog.csdn.net/fishmai/article/details/52398537</a></p>
<p>crash/WTF/ANR/Low on memory  —dropbox</p>
<p>手机的默认的日志目录：</p>
<p> /data/local/tmp/*</p>
<p>/data/tmp/*</p>
<p>/data/system/usagestats/*</p>
<p>/data/system/appusagestates/*</p>
<p>/data/system/dropbox/*</p>
<p>/data/tombstones/*</p>
<p>/data/anr/*</p>
<p>logcat的日志在</p>
<p>/dev/log/main</p>
<p>有/data/local/log目录的，可以保存3-4天的log。</p>
<p> 需要对Android的log机制有深入的研究</p>
<p> logd源码分析</p>
<p>logd源码位置:<a href="">system/core/logd</a></p>
<p>  logwraper 源码分析<br>logwraper源码位置：<a href="">system/core/logwrapper/logwrap.c</a></p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>LOG是广泛使用的用来记录程序执行过程的机制，它既可以用于程序调试，也可以用于产品运营中的事件记录。在Android系统中，提供了简单、便利的LOG机制，开发人员可以方便地使用。</p>
<h1 id="Log的使用"><a href="#Log的使用" class="headerlink" title="Log的使用"></a>Log的使用</h1><p> 本节介绍Kernel中内核态的printk和用户态的Log使用</p>
<h2 id="内核态Kernel-log的使用"><a href="#内核态Kernel-log的使用" class="headerlink" title="内核态Kernel log的使用"></a>内核态Kernel log的使用</h2><h3 id="printk的使用"><a href="#printk的使用" class="headerlink" title="printk的使用"></a>printk的使用</h3><p> Android是基于Linux内核的，所以Linux中的printk同样适用于Android.printk提供了8种日志级别<br> kernel/include/linux/kern_levels.h<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __KERN_LEVELS_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __KERN_LEVELS_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_SOH	<span class="meta-string">"\001"</span>		<span class="comment">/* ASCII Start Of Header */</span></span></span><br><span class="line">#define KERN_SOH_ASCII	'\001'</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_EMERG	KERN_SOH <span class="meta-string">"0"</span>	<span class="comment">/* system is unusable */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ALERT	KERN_SOH <span class="meta-string">"1"</span>	<span class="comment">/* action must be taken immediately */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_CRIT	KERN_SOH <span class="meta-string">"2"</span>	<span class="comment">/* critical conditions */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ERR	KERN_SOH <span class="meta-string">"3"</span>	<span class="comment">/* error conditions */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_WARNING	KERN_SOH <span class="meta-string">"4"</span>	<span class="comment">/* warning conditions */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_NOTICE	KERN_SOH <span class="meta-string">"5"</span>	<span class="comment">/* normal but significant condition */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_INFO	KERN_SOH <span class="meta-string">"6"</span>	<span class="comment">/* informational */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEBUG	KERN_SOH <span class="meta-string">"7"</span>	<span class="comment">/* debug-level messages */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEFAULT	KERN_SOH <span class="meta-string">"d"</span>	<span class="comment">/* the default kernel loglevel */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Annotation for a "continued" line of log printout (only done after a</span></span><br><span class="line"><span class="comment"> * line that had no enclosing \n). Only to be used by core/arch code</span></span><br><span class="line"><span class="comment"> * during early bootup (a continued line is not SMP-safe otherwise).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_CONT	<span class="meta-string">""</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p> printk在代码中的<strong>使用方法</strong>：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printk(KERN_ALERT<span class="string">"This is the log printed by printk in linux kernel space."</span>);</span><br></pre></td></tr></table></figure></p>
<p> 或者<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printk(<span class="string">"1"</span> <span class="string">"This is the log printed by printk in linux kernel space."</span>);</span><br></pre></td></tr></table></figure></p>
<p> KERN_ALERT表示日志级别，后面紧跟着要格式化字符串。</p>
<p> printk的log<strong>查看方法</strong>：<br> 在Android系统中，printk输出的日志信息保存在/proc/kmsg中，要查看/proc/kmsg的内容,使用命令<br> cat /proc/kmsg<br> cat /dev/kmsg<br> adb logcat -b kernel</p>
<p> 查看当前日志<strong>打印级别</strong>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/kernel/printk</span><br></pre></td></tr></table></figure></p>
<p> 输出结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 6 1 7</span><br></pre></td></tr></table></figure></p>
<p>四个值的含义：控制台日志级别、默认的消息日志级别、最低的控制台日志级别和默认的控制台日志级别</p>
<p> ★Tips: 如何调整Kernel log的日志级别?<br> 只有当printk打印信息时的loglevel小于console loglevel的值（优先级高于console loglevel），这些信息才会被打印到console上。比如当前的console loglevel是3,那么代码中loglevel为KERN_WARNING，KERN_NOTICE，KERN_INFO，KERN_DEBUG等的log将不会打印.(数字越小，日志优先级越高).</p>
<p> • 方法一：修改日志打印级别<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"7 4 1 7"</span> &gt; /proc/sys/kernel/printk</span><br></pre></td></tr></table></figure></p>
<p> 这种方法的只能对当前环境有效，关机或者重启之后，立马失效.</p>
<p> • 方法二：修改printk.c里面的日志默认级别.kernel/msm-3.18/kernel/printk/printk.c<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int console_printk[4] = &#123;</span><br><span class="line">	CONSOLE_LOGLEVEL_DEFAULT,	/* console_loglevel */</span><br><span class="line">	MESSAGE_LOGLEVEL_DEFAULT,	/* default_message_loglevel */</span><br><span class="line">	CONSOLE_LOGLEVEL_MIN,		/* minimum_console_loglevel */</span><br><span class="line">	CONSOLE_LOGLEVEL_DEFAULT,	/* default_console_loglevel */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p> 对应的修改console_loglevel,default_message_loglevel,minimum_console_loglevel,default_console_loglevel四个值即可.</p>
<h3 id="printk源码分析"><a href="#printk源码分析" class="headerlink" title="printk源码分析"></a>printk源码分析</h3><p> printk模块代码位置：kernel/msm-3.18/kernel/printk/<br> 待补充…<br> 参考资料：<br> <a href="http://book.51cto.com/art/200712/62871.htm" target="_blank" rel="noopener">printk打印消息机制</a><br> <a href="http://www.cnblogs.com/sunyubo/archive/2011/01/06/2282076.html" target="_blank" rel="noopener">printk实现分析</a><br> <a href="https://blog.csdn.net/skyflying2012/article/details/7970341" target="_blank" rel="noopener">内核printk的实现分析</a><br> <a href="https://www.cnblogs.com/pengdonglin137/p/4320965.html" target="_blank" rel="noopener">tiny4412 串口驱动分析二 — printk的实现</a><br> <a href="https://www.cnblogs.com/victor-ma/p/5332137.html" target="_blank" rel="noopener">内核日志及printk结构浅析</a></p>
<h3 id="dmesg-log"><a href="#dmesg-log" class="headerlink" title="dmesg log"></a>dmesg log</h3><ol>
<li><p>dmesg log介绍<br>dmesg里我们可以查看到开机信息，printk产生的信息等。‘dmesg’命令设备故障的诊断是非常重要的。在‘dmesg’命令的帮助下进行硬件的连接或断开连接操作时，我们可以看到硬件的检测或者断开连接的信息。</p>
</li>
<li><p>获取dmesg log<br>adb shell 后输入dmesg</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[   13.688706] i2c-msm-v2 78b6000.i2c: NACK: slave not responding, ensure its powered: msgs(n:1 cur:0 tx) bc(rx:0 tx:2) </span><br><span class="line">mode:FIFO slv_addr:0x1d MSTR_STS:0x0d1300c8 OPER:0x00000090</span><br><span class="line">[   13.703484] usb-type-c-pericom 2-001d: i2c write to [1d] failed -107</span><br><span class="line">[   13.709767] usb-type-c-pericom 2-001d: i2c access failed</span><br></pre></td></tr></table></figure>
<p>可以看到每行最开始显示的是一个综括号，里面的数字为timestamp，时间戳，该时间指示的系统从开机到现在的运行时间，单位为s 秒。</p>
</li>
<li><p>dmesg常用的方式<br>dmesg -c :在显示的同时，clean掉dmesg缓存中信息<br>dmesg -T :以当前时间的方式显示时间信息，而不是上面的那种毫秒的开机时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Wed Jan  3 06:15:22 2018] i2c-msm-v2 78b6000.i2c: NACK: slave not responding, ensure its powered: msgs(n:1 cur:0 tx) bc</span><br><span class="line">(rx:0 tx:2) mode:FIFO slv_addr:0x1d MSTR_STS:0x0d1300c8 OPER:0x00000090</span><br><span class="line">[Wed Jan  3 06:15:22 2018] usb-type-c-pericom 2-001d: i2c write to [1d] failed -107</span><br><span class="line">[Wed Jan  3 06:15:22 2018] usb-type-c-pericom 2-001d: i2c access failed</span><br></pre></td></tr></table></figure>
<p>由于dmesg日志的输出不适合在一页中完全显示，因此我们使用管道（pipe）将其输出送到more或者less命令单页显示。<br>dmesg | more :<br>dmesg | less :<br>dmesg | grep xxx:<br>dmesg -T | more :<br>dmesg -T | less :<br>dmesg -T | grep xxx:<br>dmesg | grep sda: 列出所有被监测到的硬件<br>dmesg | head  -20：只输出前20行<br>dmesg | tail -20：只输出最后20行<br>搜索包含特定字符串的被检测到的硬件：<br>dmesg | grep -i usb<br>dmesg | grep -i dma<br>dmesg | grep -i tty<br>dmesg | grep -i memory</p>
</li>
</ol>
<h3 id="串口log"><a href="#串口log" class="headerlink" title="串口log"></a>串口log</h3><p> 常遇到无法开机的状况，这时由于Android还未起来，adb等均无法使用，此时有抓串口的必要。</p>
<p> 抓取串口log方式：</p>
<ol>
<li>Windows系统，使用串口调试工具：SSCOM 5.13.1</li>
<li>Linux操作系统：串口调试工具 minicom<br><a href="https://blog.csdn.net/u013398960/article/details/72967892" target="_blank" rel="noopener">Android串口log的获取</a><br><a href="https://www.cnblogs.com/wonux/p/5897127.html" target="_blank" rel="noopener">串口调试利器–Minicom配置及使用详解</a></li>
</ol>
<h2 id="用户态Log的使用"><a href="#用户态Log的使用" class="headerlink" title="用户态Log的使用"></a>用户态Log的使用</h2><p> Android系统在用户空间中提供了轻量级的logger日志系统，它是在内核中实现的一种设备驱动，与用户空间的logcat工具配合使用能够方便地跟踪调试程序.在Android系统中，分别为C/C++ 和Java语言提供两种不同的logger访问接口。C/C++日志接口一般是在编写硬件抽象层模块或者编写JNI方法时使用，而Java接口一般是在应用层编写APP时使用。</p>
<h3 id="C-C-模块Log的使用"><a href="#C-C-模块Log的使用" class="headerlink" title="C/C++模块Log的使用"></a>C/C++模块Log的使用</h3><p> Android系统中的C/C++日志接口是通过宏来使用的。在system/core/include/android/log.h定义了日志的级别：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Android log priority values, in ascending priority order.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> android_LogPriority &#123;</span><br><span class="line">  ANDROID_LOG_UNKNOWN = <span class="number">0</span>,</span><br><span class="line">  ANDROID_LOG_DEFAULT, <span class="comment">/* only for SetMinPriority() */</span></span><br><span class="line">  ANDROID_LOG_VERBOSE,</span><br><span class="line">  ANDROID_LOG_DEBUG,</span><br><span class="line">  ANDROID_LOG_INFO,</span><br><span class="line">  ANDROID_LOG_WARN,</span><br><span class="line">  ANDROID_LOG_ERROR,</span><br><span class="line">  ANDROID_LOG_FATAL,</span><br><span class="line">  ANDROID_LOG_SILENT, <span class="comment">/* only for SetMinPriority(); must be last */</span></span><br><span class="line">&#125; android_LogPriority;</span><br></pre></td></tr></table></figure></p>
<p> 对于老的Android版本<br> 在system/core/include/cutils/log.h中，定义了对应的宏，如对应于ANDROID_LOG_VERBOSE的宏LOGV：<br> …<br> 因此，如果要使用C/C++日志接口，只要定义自己的LOG_TAG宏和包含头文件system/core/include/cutils/log.h就可以了：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define LOG_TAG "MY LOG TAG"</span></span><br><span class="line"><span class="comment">#include &lt;cutils/log.h&gt;</span></span><br></pre></td></tr></table></figure></p>
<pre><code>就可以了，例如使用LOGV：
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOGV(<span class="string">"This is the log printed by LOGV in android user space."</span>);</span><br></pre></td></tr></table></figure>
<p> Android8.1.0版本中，log模块进行了调整</p>
<p> ALOG</p>
<h3 id="Java模块Log的使用"><a href="#Java模块Log的使用" class="headerlink" title="Java模块Log的使用"></a>Java模块Log的使用</h3><p> Android系统中的Java日志接口.Android系统在Frameworks层中定义了Log接口（frameworks/base/core/java/android/util/Log.java）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Log</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.v.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VERBOSE = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.d.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEBUG = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.i.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INFO = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.w.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WARN = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.e.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ERROR = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ASSERT = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Exception class used to capture a stack trace in &#123;<span class="doctag">@link</span> #wtf&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TerribleFailure</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">        TerribleFailure(String msg, Throwable cause) &#123; <span class="keyword">super</span>(msg, cause); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Interface to handle terrible failures from &#123;<span class="doctag">@link</span> #wtf&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TerribleFailureHandler</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onTerribleFailure</span><span class="params">(String tag, TerribleFailure what, <span class="keyword">boolean</span> system)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TerribleFailureHandler sWtfHandler = <span class="keyword">new</span> TerribleFailureHandler() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTerribleFailure</span><span class="params">(String tag, TerribleFailure what, <span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">                RuntimeInit.wtf(tag, what, system);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Log</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send a &#123;<span class="doctag">@link</span> #VERBOSE&#125; log message.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag Used to identify the source of a log message.  It usually identifies</span></span><br><span class="line"><span class="comment">     *        the class or activity where the log call occurs.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg The message you would like logged.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">v</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> println_native(LOG_ID_MAIN, VERBOSE, tag, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send a &#123;<span class="doctag">@link</span> #VERBOSE&#125; log message and log the exception.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag Used to identify the source of a log message.  It usually identifies</span></span><br><span class="line"><span class="comment">     *        the class or activity where the log call occurs.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg The message you would like logged.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tr An exception to log</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">v</span><span class="params">(String tag, String msg, Throwable tr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> printlns(LOG_ID_MAIN, VERBOSE, tag, msg, tr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   ....</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checks to see whether or not a log for the specified tag is loggable at the specified level.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  The default level of any tag is set to INFO. This means that any level above and including</span></span><br><span class="line"><span class="comment">     *  INFO will be logged. Before you make any calls to a logging method you should check to see</span></span><br><span class="line"><span class="comment">     *  if your tag should be logged. You can change the default level by setting a system property:</span></span><br><span class="line"><span class="comment">     *      'setprop log.tag.&amp;lt;YOUR_LOG_TAG&gt; &amp;lt;LEVEL&gt;'</span></span><br><span class="line"><span class="comment">     *  Where level is either VERBOSE, DEBUG, INFO, WARN, ERROR, ASSERT, or SUPPRESS. SUPPRESS will</span></span><br><span class="line"><span class="comment">     *  turn off all logging for your tag. You can also create a local.prop file that with the</span></span><br><span class="line"><span class="comment">     *  following in it:</span></span><br><span class="line"><span class="comment">     *      'log.tag.&amp;lt;YOUR_LOG_TAG&gt;=&amp;lt;LEVEL&gt;'</span></span><br><span class="line"><span class="comment">     *  and place that in /data/local.prop.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag The tag to check.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> level The level to check.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Whether or not that this is allowed to be logged.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException is thrown if the tag.length() &gt; 23</span></span><br><span class="line"><span class="comment">     *         for Nougat (7.0) releases (API &lt;= 23) and prior, there is no</span></span><br><span class="line"><span class="comment">     *         tag limit of concern after this API level.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">isLoggable</span><span class="params">(String tag, <span class="keyword">int</span> level)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Send a &#123;@link #WARN&#125; log message and log the exception.</span></span><br><span class="line"><span class="comment">     * @param tag Used to identify the source of a log message.  It usually identifies</span></span><br><span class="line"><span class="comment">     *        the class or activity where the log call occurs.</span></span><br><span class="line"><span class="comment">     * @param tr An exception to log</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">w</span><span class="params">(String tag, Throwable tr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> printlns(LOG_ID_MAIN, WARN, tag, <span class="string">""</span>, tr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send an &#123;<span class="doctag">@link</span> #ERROR&#125; log message.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag Used to identify the source of a log message.  It usually identifies</span></span><br><span class="line"><span class="comment">     *        the class or activity where the log call occurs.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg The message you would like logged.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">e</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> println_native(LOG_ID_MAIN, ERROR, tag, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send a &#123;<span class="doctag">@link</span> #ERROR&#125; log message and log the exception.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag Used to identify the source of a log message.  It usually identifies</span></span><br><span class="line"><span class="comment">     *        the class or activity where the log call occurs.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg The message you would like logged.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tr An exception to log</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">e</span><span class="params">(String tag, String msg, Throwable tr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> printlns(LOG_ID_MAIN, ERROR, tag, msg, tr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * What a Terrible Failure: Report a condition that should never happen.</span></span><br><span class="line"><span class="comment">     * The error will always be logged at level ASSERT with the call stack.</span></span><br><span class="line"><span class="comment">     * Depending on system configuration, a report may be added to the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> android.os.DropBoxManager&#125; and/or the process may be terminated</span></span><br><span class="line"><span class="comment">     * immediately with an error dialog.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag Used to identify the source of a log message.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg The message you would like logged.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">wtf</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> wtf(LOG_ID_MAIN, tag, msg, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Like &#123;<span class="doctag">@link</span> #wtf(String, String)&#125;, but also writes to the log the full</span></span><br><span class="line"><span class="comment">     * call stack.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">wtfStack</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> wtf(LOG_ID_MAIN, tag, msg, <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * What a Terrible Failure: Report an exception that should never happen.</span></span><br><span class="line"><span class="comment">     * Similar to &#123;<span class="doctag">@link</span> #wtf(String, String)&#125;, with an exception to log.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag Used to identify the source of a log message.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tr An exception to log.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">wtf</span><span class="params">(String tag, Throwable tr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> wtf(LOG_ID_MAIN, tag, tr.getMessage(), tr, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * What a Terrible Failure: Report an exception that should never happen.</span></span><br><span class="line"><span class="comment">     * Similar to &#123;<span class="doctag">@link</span> #wtf(String, Throwable)&#125;, with a message as well.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag Used to identify the source of a log message.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg The message you would like logged.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tr An exception to log.  May be null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">wtf</span><span class="params">(String tag, String msg, Throwable tr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> wtf(LOG_ID_MAIN, tag, msg, tr, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">wtf</span><span class="params">(<span class="keyword">int</span> logId, String tag, String msg, Throwable tr, <span class="keyword">boolean</span> localStack,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">        TerribleFailure what = <span class="keyword">new</span> TerribleFailure(msg, tr);</span><br><span class="line">        <span class="comment">// Only mark this as ERROR, do not use ASSERT since that should be</span></span><br><span class="line">        <span class="comment">// reserved for cases where the system is guaranteed to abort.</span></span><br><span class="line">        <span class="comment">// The onTerribleFailure call does not always cause a crash.</span></span><br><span class="line">        <span class="keyword">int</span> bytes = printlns(logId, ERROR, tag, msg, localStack ? what : tr);</span><br><span class="line">        sWtfHandler.onTerribleFailure(tag, what, system);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">wtfQuiet</span><span class="params">(<span class="keyword">int</span> logId, String tag, String msg, <span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">        TerribleFailure what = <span class="keyword">new</span> TerribleFailure(msg, <span class="keyword">null</span>);</span><br><span class="line">        sWtfHandler.onTerribleFailure(tag, what, system);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the terrible failure handler, for testing.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the old handler</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TerribleFailureHandler <span class="title">setWtfHandler</span><span class="params">(TerribleFailureHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"handler == null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        TerribleFailureHandler oldHandler = sWtfHandler;</span><br><span class="line">        sWtfHandler = handler;</span><br><span class="line">        <span class="keyword">return</span> oldHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handy function to get a loggable stack trace from a Throwable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tr An exception to log</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getStackTraceString</span><span class="params">(Throwable tr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tr == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is to reduce the amount of log spew that apps do in the non-error</span></span><br><span class="line">        <span class="comment">// condition of the network being unavailable.</span></span><br><span class="line">        Throwable t = tr;</span><br><span class="line">        <span class="keyword">while</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> UnknownHostException) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            t = t.getCause();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StringWriter sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">        PrintWriter pw = <span class="keyword">new</span> FastPrintWriter(sw, <span class="keyword">false</span>, <span class="number">256</span>);</span><br><span class="line">        tr.printStackTrace(pw);</span><br><span class="line">        pw.flush();</span><br><span class="line">        <span class="keyword">return</span> sw.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Low-level logging call.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> priority The priority/type of this log message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag Used to identify the source of a log message.  It usually identifies</span></span><br><span class="line"><span class="comment">     *        the class or activity where the log call occurs.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg The message you would like logged.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The number of bytes written.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">println</span><span class="params">(<span class="keyword">int</span> priority, String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> println_native(LOG_ID_MAIN, priority, tag, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_MAIN = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_RADIO = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_EVENTS = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_SYSTEM = <span class="number">3</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_CRASH = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">println_native</span><span class="params">(<span class="keyword">int</span> bufID,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> priority, String tag, String msg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the maximum payload the log daemon accepts without truncation.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> LOGGER_ENTRY_MAX_PAYLOAD.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">logger_entry_max_payload_native</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helper function for long messages. Uses the LineBreakBufferedWriter to break</span></span><br><span class="line"><span class="comment">     * up long messages and stacktraces along newlines, but tries to write in large</span></span><br><span class="line"><span class="comment">     * chunks. This is to avoid truncation.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">printlns</span><span class="params">(<span class="keyword">int</span> bufID, <span class="keyword">int</span> priority, String tag, String msg,</span></span></span><br><span class="line"><span class="function"><span class="params">            Throwable tr)</span> </span>&#123;</span><br><span class="line">        ImmediateLogWriter logWriter = <span class="keyword">new</span> ImmediateLogWriter(bufID, priority, tag);</span><br><span class="line">        <span class="comment">// Acceptable buffer size. Get the native buffer size, subtract two zero terminators,</span></span><br><span class="line">        <span class="comment">// and the length of the tag.</span></span><br><span class="line">        <span class="comment">// Note: we implicitly accept possible truncation for Modified-UTF8 differences. It</span></span><br><span class="line">        <span class="comment">//       is too expensive to compute that ahead of time.</span></span><br><span class="line">        <span class="keyword">int</span> bufferSize = PreloadHolder.LOGGER_ENTRY_MAX_PAYLOAD    <span class="comment">// Base.</span></span><br><span class="line">                - <span class="number">2</span>                                                <span class="comment">// Two terminators.</span></span><br><span class="line">                - (tag != <span class="keyword">null</span> ? tag.length() : <span class="number">0</span>)                 <span class="comment">// Tag length.</span></span><br><span class="line">                - <span class="number">32</span>;                                              <span class="comment">// Some slack.</span></span><br><span class="line">        <span class="comment">// At least assume you can print *some* characters (tag is not too large).</span></span><br><span class="line">        bufferSize = Math.max(bufferSize, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        LineBreakBufferedWriter lbbw = <span class="keyword">new</span> LineBreakBufferedWriter(logWriter, bufferSize);</span><br><span class="line"></span><br><span class="line">        lbbw.println(msg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is to reduce the amount of log spew that apps do in the non-error</span></span><br><span class="line">            <span class="comment">// condition of the network being unavailable.</span></span><br><span class="line">            Throwable t = tr;</span><br><span class="line">            <span class="keyword">while</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (t <span class="keyword">instanceof</span> UnknownHostException) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (t <span class="keyword">instanceof</span> DeadSystemException) &#123;</span><br><span class="line">                    lbbw.println(<span class="string">"DeadSystemException: The system died; "</span></span><br><span class="line">                            + <span class="string">"earlier logs will point to the root cause"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                t = t.getCause();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">                tr.printStackTrace(lbbw);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lbbw.flush();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> logWriter.getWritten();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PreloadHelper class. Caches the LOGGER_ENTRY_MAX_PAYLOAD value to avoid</span></span><br><span class="line"><span class="comment">     * a JNI call during logging.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PreloadHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LOGGER_ENTRY_MAX_PAYLOAD =</span><br><span class="line">                logger_entry_max_payload_native();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helper class to write to the logcat. Different from LogWriter, this writes</span></span><br><span class="line"><span class="comment">     * the whole given buffer and does not break along newlines.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ImmediateLogWriter</span> <span class="keyword">extends</span> <span class="title">Writer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> bufID;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> priority;</span><br><span class="line">        <span class="keyword">private</span> String tag;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> written = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Create a writer that immediately writes to the log, using the given</span></span><br><span class="line"><span class="comment">         * parameters.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ImmediateLogWriter</span><span class="params">(<span class="keyword">int</span> bufID, <span class="keyword">int</span> priority, String tag)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.bufID = bufID;</span><br><span class="line">            <span class="keyword">this</span>.priority = priority;</span><br><span class="line">            <span class="keyword">this</span>.tag = tag;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWritten</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> written;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span>[] cbuf, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Note: using String here has a bit of overhead as a Java object is created,</span></span><br><span class="line">            <span class="comment">//       but using the char[] directly is not easier, as it needs to be translated</span></span><br><span class="line">            <span class="comment">//       to a C char[] for logging.</span></span><br><span class="line">            written += println_native(bufID, priority, tag, <span class="keyword">new</span> String(cbuf, off, len));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Ignored.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Ignored.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 因此，如果要使用Java日志接口，只要在类中定义的LOG_TAG常量和引用android.util.Log就可以了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TAG = <span class="string">"MY_LOG_TAG"</span>;</span><br><span class="line">Log.i(LOG_TAG, <span class="string">"This is the log printed by Log.i in android user space."</span>);</span><br></pre></td></tr></table></figure></p>
<p> 用户态log查看工具： logcat</p>
<p> ★ Tips：logcat输出log的级别控制</p>
<h2 id="logcat的使用"><a href="#logcat的使用" class="headerlink" title="logcat的使用"></a>logcat的使用</h2><p> 参考资料<br> <a href="https://zhuanlan.zhihu.com/p/24372024" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/24372024</a></p>
<h1 id="Framework中Log功能解析"><a href="#Framework中Log功能解析" class="headerlink" title="Framework中Log功能解析"></a>Framework中Log功能解析</h1><p> AP侧的Log系统根据log类型，分为main,system,radio,crash,events.<br> frameworks/base/core/java/android/util/Log.java //用于记录main log<br> frameworks/base/core/java/android/util/Slog.java //用于记录framework log<br> frameworks/base/telephony/java/android/telephony/Rlog.java //用于记录radio log<br> frameworks/base/core/java/com/android/internal/os/RuntimeInit.java //内部记录了crash log<br> frameworks/base/core/java/android/util/EventLog.java //用于Event log的使用</p>
<p> 上述5种类型的log可以分为3大类：<br> 第一类：main/system/radio<br> 第二类：event<br> 第三类：crash</p>
<h2 id="main-system-radio-log"><a href="#main-system-radio-log" class="headerlink" title="main/system/radio log"></a>main/system/radio log</h2><p> 从Log.java,Slog.java,Rlog.java三个文件来看，这三种log最大的区别就是LOG_ID不一样，即在framework侧已经区分了写入不同的缓冲区,如下：<br> Log.java,通过println_native写入LOG_ID_MAIN缓冲区<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Send a &#123;<span class="doctag">@link</span> #VERBOSE&#125; log message.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tag Used to identify the source of a log message.  It usually identifies</span></span><br><span class="line"><span class="comment"> *        the class or activity where the log call occurs.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg The message you would like logged.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">v</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> println_native(LOG_ID_MAIN, VERBOSE, tag, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> Slog.java,通过println_native写入LOG_ID_SYSTEM缓冲区<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">v</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Log.println_native(Log.LOG_ID_SYSTEM, Log.VERBOSE, tag, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> Rlog.java,通过println_native写入LOG_ID_RADIO缓冲区<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">v</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Log.println_native(Log.LOG_ID_RADIO, Log.VERBOSE, tag, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> Slog和Rlog都是调用Log里面的println_native函数，只是缓冲区ID不一样而已.<br> 对于这三类log，主要分析Log.java.Log主要实现以下函数：<br>  • 定义了Log的5中优先级,分别是 VERBOSE &gt; DEBUG &gt; INFO &gt; WARN &gt; ERROR &gt; ASSERT,数字越大优先级越高<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.v.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VERBOSE = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.d.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEBUG = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.i.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INFO = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.w.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WARN = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method; use Log.e.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ERROR = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Priority constant for the println method.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ASSERT = <span class="number">7</span>;</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line"> • 带Tag和msg两个参数的实现,最后通过JNI调用println_native函数实现，后面继续分析.</span><br><span class="line">```java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">v</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> println_native(LOG_ID_MAIN, VERBOSE, tag, msg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p> • 带Tag,msg以及Throwable三个参数的实现,<a href="https://github.com/EricChows/JDK-1.8-sourcecode/blob/master/java/lang/Throwable.java" target="_blank" rel="noopener">可以在这里查看Throwable的源码</a>，多了一个异常参数.在输出log信息的同时，如果报了异常，同时将异常信息输出.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">v</span><span class="params">(String tag, String msg, Throwable tr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> printlns(LOG_ID_MAIN, VERBOSE, tag, msg, tr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 通过printlns函数实现,继续追踪printlns函数如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Helper function for long messages. Uses the LineBreakBufferedWriter to break</span></span><br><span class="line"><span class="comment"> * up long messages and stacktraces along newlines, but tries to write in large</span></span><br><span class="line"><span class="comment"> * chunks. This is to avoid truncation.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">printlns</span><span class="params">(<span class="keyword">int</span> bufID, <span class="keyword">int</span> priority, String tag, String msg,</span></span></span><br><span class="line"><span class="function"><span class="params">        Throwable tr)</span> </span>&#123;</span><br><span class="line">    ImmediateLogWriter logWriter = <span class="keyword">new</span> ImmediateLogWriter(bufID, priority, tag);</span><br><span class="line">    <span class="comment">// Acceptable buffer size. Get the native buffer size, subtract two zero terminators,</span></span><br><span class="line">    <span class="comment">// and the length of the tag.</span></span><br><span class="line">    <span class="comment">// Note: we implicitly accept possible truncation for Modified-UTF8 differences. It</span></span><br><span class="line">    <span class="comment">//       is too expensive to compute that ahead of time.</span></span><br><span class="line">    <span class="keyword">int</span> bufferSize = PreloadHolder.LOGGER_ENTRY_MAX_PAYLOAD    <span class="comment">// Base.</span></span><br><span class="line">            - <span class="number">2</span>                                                <span class="comment">// Two terminators.</span></span><br><span class="line">            - (tag != <span class="keyword">null</span> ? tag.length() : <span class="number">0</span>)                 <span class="comment">// Tag length.</span></span><br><span class="line">            - <span class="number">32</span>;                                              <span class="comment">// Some slack.</span></span><br><span class="line">    <span class="comment">// At least assume you can print *some* characters (tag is not too large).</span></span><br><span class="line">    bufferSize = Math.max(bufferSize, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    LineBreakBufferedWriter lbbw = <span class="keyword">new</span> LineBreakBufferedWriter(logWriter, bufferSize);</span><br><span class="line"></span><br><span class="line">    lbbw.println(msg); <span class="comment">//println函数后面还是调用了println_native</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// This is to reduce the amount of log spew that apps do in the non-error</span></span><br><span class="line">        <span class="comment">// condition of the network being unavailable.</span></span><br><span class="line">        Throwable t = tr;</span><br><span class="line">        <span class="keyword">while</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> UnknownHostException) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> DeadSystemException) &#123;</span><br><span class="line">                lbbw.println(<span class="string">"DeadSystemException: The system died; "</span></span><br><span class="line">                        + <span class="string">"earlier logs will point to the root cause"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            t = t.getCause();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">            tr.printStackTrace(lbbw);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lbbw.flush();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> logWriter.getWritten();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 由于带有异常信息，一般异常信息都很长很大，而且里面有换行符,而每条log信息长度最大只能是4k个字节，所以为了避免信息被截断，在写入缓冲区之前，需要对这类信息进行预处理,也就是进行切割，分成多行显示.使用LineBreakBufferedWriter类刚好符合这样的要求，将这样的msg，识别出换行符之后，切割成多块，分行显示.</p>
<p> • 实现println函数,也就是说我们也可以用Log.println函数来实现log的输出，不过使用的比较少.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Low-level logging call.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> priority The priority/type of this log message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tag Used to identify the source of a log message.  It usually identifies</span></span><br><span class="line"><span class="comment"> *        the class or activity where the log call occurs.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg The message you would like logged.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The number of bytes written.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">println</span><span class="params">(<span class="keyword">int</span> priority, String tag, String msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> println_native(LOG_ID_MAIN, priority, tag, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> • 实现了wtf的多个重载方法,wtf的解释是What a Terrible Failure: Report a condition that should never happen.The error will always be logged at level ASSERT with the call stack.Depending on system configuration, a report may be added to the { @link android.os.DropBoxManager } and/or the process may be terminated immediately with an error dialog. 表示此时遇到了一个不可能发生，严重而又无法挽救的情况,对应的是ASSERT级别的日志,一般用于系统应用中，会用在Dropbox日志以及立即杀死进程弹框等场景下.这些应用留给后面讲Dropbox log以及ANR等具体使用的时候现场分析.</p>
<h2 id="Event-log"><a href="#Event-log" class="headerlink" title="Event log"></a>Event log</h2><p> 第二类的EventLog,可以在Java和C/C++代码中使用，用于特殊事件的打点,这里说的事件不仅仅值的输入事件,还包括特殊场景的特殊状态，比如Activity，Window等状态.由于Eventlog的实现机制和上面第一类的不一样，下面的章节会单独将Eventlog作为一节来讲，请往下面章节看.本节主要分析EventLog.java的功能.</p>
<p> a)实现writeEvent函数，通过JNI，调用到底层的代码，最终将event写入到<strong>/dev/log/events(之前版本写入的是这里，现在的8.1.0版本不再是这里了)</strong><br> b)实现readEvents函数，通过JNI,调用到底层代码, 具体使用场景还不没找,提供了方法来读取对应type的eventlog<br> c)实现getTagName函数，通过给出的ID，返回Tag的名称，主要通过在system/etc/event-log-tags文件里面进行查找实现，供Java侧其他模块调用<br> d)实现getTagCode函数，通过给出的Tag名称，返回Tag的ID，主要通过在system/etc/event-log-tags文件里面进行查找实现，供Java侧其他模块调用<br> e)实现内部静态类Event，这个是8.1.0之前的老版本的EventLog的实现.暂不关注.</p>
<h2 id="crash-log"><a href="#crash-log" class="headerlink" title="crash log"></a>crash log</h2><p> 对于第三类crash log.用于捕获应用的异常.<br> RuntimeInit.java是通过app_server启动，看frameworks/base/cmds/app_process/app_main.cpp代码如下:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 我们来看一下frameworks/base/core/java/com/android/internal/os/RuntimeInit.java,从上面代码可以看出，RuntimeInit是所有APP 进程的入口，AP侧的所有进程都是从这里启动，负责进程初始化的，继续看RuntimeInit代码实现的功能,在RuntimeInit.java中Clog_e函数里面可以看到crash log是输出到LOG_ID_CRASH缓冲区里面的,当然应用crash时的日志级别也是ERROR级的，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">Clog_e</span><span class="params">(String tag, String msg, Throwable tr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Log.printlns(Log.LOG_ID_CRASH, Log.ERROR, tag, msg, tr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> RuntimeInit里面有两个内部类LoggingHandler和KillApplicationHandler分别用于捕获线程和Application的异常信息并输出log.下面分别来看一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logs a message when a thread encounters an uncaught exception. By</span></span><br><span class="line"><span class="comment"> * default, &#123;<span class="doctag">@link</span> KillApplicationHandler&#125; will terminate this process later,</span></span><br><span class="line"><span class="comment"> * but apps can override that behavior.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingHandler</span> <span class="keyword">implements</span> <span class="title">Thread</span>.<span class="title">UncaughtExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Don't re-enter if KillApplicationHandler has already run</span></span><br><span class="line">        <span class="keyword">if</span> (mCrashing) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (mApplicationObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The "FATAL EXCEPTION" string is still used on Android even though</span></span><br><span class="line">            <span class="comment">// apps can set a custom UncaughtExceptionHandler that renders uncaught</span></span><br><span class="line">            <span class="comment">// exceptions non-fatal.</span></span><br><span class="line">            Clog_e(TAG, <span class="string">"*** FATAL EXCEPTION IN SYSTEM PROCESS: "</span> + t.getName(), e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            StringBuilder message = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="comment">// The "FATAL EXCEPTION" string is still used on Android even though</span></span><br><span class="line">            <span class="comment">// apps can set a custom UncaughtExceptionHandler that renders uncaught</span></span><br><span class="line">            <span class="comment">// exceptions non-fatal.</span></span><br><span class="line">            message.append(<span class="string">"FATAL EXCEPTION: "</span>).append(t.getName()).append(<span class="string">"\n"</span>);</span><br><span class="line">            <span class="keyword">final</span> String processName = ActivityThread.currentProcessName();</span><br><span class="line">            <span class="keyword">if</span> (processName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                message.append(<span class="string">"Process: "</span>).append(processName).append(<span class="string">", "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            message.append(<span class="string">"PID: "</span>).append(Process.myPid());</span><br><span class="line">            Clog_e(TAG, message.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 从代码中可以看到，当ApplicationObject为空的时候，表示Binder出了问题，此时应该是系统进程出问题了，会打印，*** FATAL EXCEPTION IN SYSTEM PROCESS: 等字符串.<br> 如果线程遇到了其他异常，会打印FATAL EXCEPTION:，以及当前进程名称，进程ID号.如下有一个实例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">06-14 11:08:30.924 10048  2484  2585 E AndroidRuntime: FATAL EXCEPTION: AsyncTask #1</span><br><span class="line"><span class="number">06</span>-<span class="number">14</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">30.924</span> <span class="number">10048</span>  <span class="number">2484</span>  <span class="number">2585</span> E AndroidRuntime: Process: com.emoji.keyboard.touchpal.go, PID: <span class="number">2484</span></span><br><span class="line"><span class="number">06</span>-<span class="number">14</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">30.924</span> <span class="number">10048</span>  <span class="number">2484</span>  <span class="number">2585</span> E AndroidRuntime: java.lang.IllegalStateException: SharedPreferences in credential encrypted storage are not available until after user is unlocked</span><br><span class="line"><span class="number">06</span>-<span class="number">14</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">30.924</span> <span class="number">10048</span>  <span class="number">2484</span>  <span class="number">2585</span> E AndroidRuntime: 	at android.app.ContextImpl.getSharedPreferences(ContextImpl.java:<span class="number">391</span>)</span><br><span class="line"><span class="number">06</span>-<span class="number">14</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">30.924</span> <span class="number">10048</span>  <span class="number">2484</span>  <span class="number">2585</span> E AndroidRuntime: 	at android.app.ContextImpl.getSharedPreferences(ContextImpl.java:<span class="number">376</span>)</span><br><span class="line"><span class="number">06</span>-<span class="number">14</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">30.924</span> <span class="number">10048</span>  <span class="number">2484</span>  <span class="number">2585</span> E AndroidRuntime: 	at android.content.ContextWrapper.getSharedPreferences(ContextWrapper.java:<span class="number">167</span>)</span><br><span class="line"><span class="number">06</span>-<span class="number">14</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">30.924</span> <span class="number">10048</span>  <span class="number">2484</span>  <span class="number">2585</span> E AndroidRuntime: 	at com.facebook.internal.FetchedAppSettingsManager$<span class="number">1</span>.run(SourceFile:<span class="number">106</span>)</span><br><span class="line"><span class="number">06</span>-<span class="number">14</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">30.924</span> <span class="number">10048</span>  <span class="number">2484</span>  <span class="number">2585</span> E AndroidRuntime: 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1162</span>)</span><br><span class="line"><span class="number">06</span>-<span class="number">14</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">30.924</span> <span class="number">10048</span>  <span class="number">2484</span>  <span class="number">2585</span> E AndroidRuntime: 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">636</span>)</span><br><span class="line"><span class="number">06</span>-<span class="number">14</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">30.924</span> <span class="number">10048</span>  <span class="number">2484</span>  <span class="number">2585</span> E AndroidRuntime: 	at java.lang.Thread.run(Thread.java:<span class="number">764</span>)</span><br></pre></td></tr></table></figure></p>
<p> 继续看KillApplicationHandler的异常捕获:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handle application death from an uncaught exception.  The framework</span></span><br><span class="line"><span class="comment"> * catches these for the main threads, so this should only matter for</span></span><br><span class="line"><span class="comment"> * threads created by applications.  Before this method runs,</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> LoggingHandler&#125; will already have logged details.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">KillApplicationHandler</span> <span class="keyword">implements</span> <span class="title">Thread</span>.<span class="title">UncaughtExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Don't re-enter -- avoid infinite loops if crash-reporting crashes.</span></span><br><span class="line">            <span class="keyword">if</span> (mCrashing) <span class="keyword">return</span>;</span><br><span class="line">            mCrashing = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Try to end profiling. If a profiler is running at this point, and we kill the</span></span><br><span class="line">            <span class="comment">// process (below), the in-memory buffer will be lost. So try to stop, which will</span></span><br><span class="line">            <span class="comment">// flush the buffer. (This makes method trace profiling useful to debug crashes.)</span></span><br><span class="line">            <span class="keyword">if</span> (ActivityThread.currentActivityThread() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ActivityThread.currentActivityThread().stopProfiling();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Bring up crash dialog, wait for it to be dismissed</span></span><br><span class="line">            ActivityManager.getService().handleApplicationCrash(</span><br><span class="line">                    mApplicationObject, <span class="keyword">new</span> ApplicationErrorReport.ParcelableCrashInfo(e));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</span><br><span class="line">            <span class="keyword">if</span> (t2 <span class="keyword">instanceof</span> DeadObjectException) &#123;</span><br><span class="line">                <span class="comment">// System process is dead; ignore</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Clog_e(TAG, <span class="string">"Error reporting crash"</span>, t2);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t3) &#123;</span><br><span class="line">                    <span class="comment">// Even Clog_e() fails!  Oh well.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Try everything to make sure this process goes away.</span></span><br><span class="line">            Process.killProcess(Process.myPid());</span><br><span class="line">            System.exit(<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 可以看到，调用了ActivityManager中的handleApplicationCrash方法来处理,如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Used by &#123;<span class="doctag">@link</span> com.android.internal.os.RuntimeInit&#125; to report when an application crashes.</span></span><br><span class="line"><span class="comment"> * The application process will exit immediately after this call returns.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> app object of the crashing app, null for the system server</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> crashInfo describing the exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleApplicationCrash</span><span class="params">(IBinder app,</span></span></span><br><span class="line"><span class="function"><span class="params">        ApplicationErrorReport.ParcelableCrashInfo crashInfo)</span> </span>&#123;</span><br><span class="line">    ProcessRecord r = findAppProcess(app, <span class="string">"Crash"</span>);</span><br><span class="line">    <span class="keyword">final</span> String processName = app == <span class="keyword">null</span> ? <span class="string">"system_server"</span></span><br><span class="line">            : (r == <span class="keyword">null</span> ? <span class="string">"unknown"</span> : r.processName);</span><br><span class="line"></span><br><span class="line">    handleApplicationCrashInner(<span class="string">"crash"</span>, r, processName, crashInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Native crash reporting uses this inner version because it needs to be somewhat</span></span><br><span class="line"><span class="comment"> * decoupled from the AM-managed cleanup lifecycle</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleApplicationCrashInner</span><span class="params">(String eventType, ProcessRecord r, String processName,</span></span></span><br><span class="line"><span class="function"><span class="params">        ApplicationErrorReport.CrashInfo crashInfo)</span> </span>&#123;</span><br><span class="line">    EventLog.writeEvent(EventLogTags.AM_CRASH, Binder.getCallingPid(),</span><br><span class="line">            UserHandle.getUserId(Binder.getCallingUid()), processName,</span><br><span class="line">            r == <span class="keyword">null</span> ? -<span class="number">1</span> : r.info.flags,</span><br><span class="line">            crashInfo.exceptionClassName,</span><br><span class="line">            crashInfo.exceptionMessage,</span><br><span class="line">            crashInfo.throwFileName,</span><br><span class="line">            crashInfo.throwLineNumber);</span><br><span class="line"></span><br><span class="line">    addErrorToDropBox(eventType, r, processName, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, crashInfo);</span><br><span class="line"></span><br><span class="line">    mAppErrors.crashApplication(r, crashInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 可以看到发生crash时，也往event log里面写入了crash事件，接着干两件事<br> 一：addErrorToDropBox,addErrorToDropBox函数是将crash/WTF/ANR/Low on memory 等信息收集并拼接处头部信息后输出到dropbox文件中.<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Write a description of an error (crash, WTF, ANR) to the drop box.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventType to include in the drop box tag ("crash", "wtf", etc.)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> process which caused the error, null means the system server</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> activity which triggered the error, null if unknown</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parent activity related to the error, null if unknown</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> subject line related to the error, null if absent</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> report in long form describing the error, null if absent</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dataFile text file to include in the report, null if none</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> crashInfo giving an application stack trace, null if absent</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addErrorToDropBox</span><span class="params">(String eventType,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProcessRecord process, String processName, ActivityRecord activity,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord parent, String subject,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> String report, <span class="keyword">final</span> File dataFile,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> ApplicationErrorReport.CrashInfo crashInfo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// NOTE -- this must never acquire the ActivityManagerService lock,</span></span><br><span class="line">    <span class="comment">// otherwise the watchdog may be prevented from resetting the system.</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 二：mAppErrors.crashApplication(r, crashInfo);我们到AppErrors.java中看看crashApplication,可以看到主要目的是对发生crash的APP,杀死进程后弹出一个dialog框告知用户or not.详细的处理逻辑见crashApplicationInner函数.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bring up the "unexpected error" dialog box for a crashing app.</span></span><br><span class="line"><span class="comment"> * Deal with edge cases (intercepts from instrumented applications,</span></span><br><span class="line"><span class="comment"> * ActivityController, error intent receivers, that sort of thing).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> r the application crashing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> crashInfo describing the failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">crashApplication</span><span class="params">(ProcessRecord r, ApplicationErrorReport.CrashInfo crashInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        crashApplicationInner(r, crashInfo, callingPid, callingUid);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="JNI中log功能解析"><a href="#JNI中log功能解析" class="headerlink" title="JNI中log功能解析"></a>JNI中log功能解析</h1><p> 在上一节中总结了Framework层中提供了一些log方法供Java侧来使用，最后都调用到了frameworks/base/core/java/android/util/Log.java里面的println_native这个native函数，本节就开始往下追踪println_native函数的实现.<br> 再讲两个Log.java里面我们看到的细节：<br> 一、log总共有5个缓冲区,如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_MAIN = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_RADIO = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_EVENTS = <span class="number">2</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_SYSTEM = <span class="number">3</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOG_ID_CRASH = <span class="number">4</span>;</span><br></pre></td></tr></table></figure></p>
<p> 二、共调用了三个native方法,println_native,logger_entry_max_payload_native,isLoggable<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">println_native</span><span class="params">(<span class="keyword">int</span> bufID,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> priority, String tag, String msg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the maximum payload the log daemon accepts without truncation.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> LOGGER_ENTRY_MAX_PAYLOAD.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">logger_entry_max_payload_native</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks to see whether or not a log for the specified tag is loggable at the specified level.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  The default level of any tag is set to INFO. This means that any level above and including</span></span><br><span class="line"><span class="comment"> *  INFO will be logged. Before you make any calls to a logging method you should check to see</span></span><br><span class="line"><span class="comment"> *  if your tag should be logged. You can change the default level by setting a system property:</span></span><br><span class="line"><span class="comment"> *      'setprop log.tag.&amp;lt;YOUR_LOG_TAG&gt; &amp;lt;LEVEL&gt;'</span></span><br><span class="line"><span class="comment"> *  Where level is either VERBOSE, DEBUG, INFO, WARN, ERROR, ASSERT, or SUPPRESS. SUPPRESS will</span></span><br><span class="line"><span class="comment"> *  turn off all logging for your tag. You can also create a local.prop file that with the</span></span><br><span class="line"><span class="comment"> *  following in it:</span></span><br><span class="line"><span class="comment"> *      'log.tag.&amp;lt;YOUR_LOG_TAG&gt;=&amp;lt;LEVEL&gt;'</span></span><br><span class="line"><span class="comment"> *  and place that in /data/local.prop.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tag The tag to check.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> level The level to check.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Whether or not that this is allowed to be logged.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException is thrown if the tag.length() &gt; 23</span></span><br><span class="line"><span class="comment"> *         for Nougat (7.0) releases (API &lt;= 23) and prior, there is no</span></span><br><span class="line"><span class="comment"> *         tag limit of concern after this API level.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">isLoggable</span><span class="params">(String tag, <span class="keyword">int</span> level)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p> <strong>logger_entry_max_payload_native</strong>函数用于获取每条log的缓冲区大小，避免太长的log被截断而存入不完整.<br> <strong>isLoggable</strong>函数是在7.0之后的版本上加入的，可以获取到某个tag相对应的Level级别的log能否打印，可以通过在local.prop文件中设置这个属性.具体怎么设置，还需要继续往下追踪代码.</p>
<p> 接下来继续往下追踪println_native的流程,到frameworks/base/core/jni/android_util_Log.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * JNI registration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">    <span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line">    &#123; <span class="string">"isLoggable"</span>,      <span class="string">"(Ljava/lang/String;I)Z"</span>, (<span class="keyword">void</span>*) android_util_Log_isLoggable &#125;,</span><br><span class="line">    &#123; <span class="string">"println_native"</span>,  <span class="string">"(IILjava/lang/String;Ljava/lang/String;)I"</span>, (<span class="keyword">void</span>*) android_util_Log_println_native &#125;,</span><br><span class="line">    &#123; <span class="string">"logger_entry_max_payload_native"</span>,  <span class="string">"()I"</span>, (<span class="keyword">void</span>*) android_util_Log_logger_entry_max_payload_native &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p> JNI中，Log.java中的三个native方法，分别通过android_util_Log_isLoggable，android_util_Log_println_native，<br> android_util_Log_logger_entry_max_payload_native实现，我们先来看看frameworks/base/core/jni这个目录中Android这个编译文件，在这里我们看到需要的与log相关的依赖库有liblog,libnativehelper,libutils,libcutils,libandroidfw,libbase等这些lib库文件.</p>
<p> 一、查看android_util_Log_isLoggable函数的实现,最后调用的是__android_log_is_loggable函数,如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">android_util_Log_isLoggable</span><span class="params">(JNIEnv* env, jobject clazz, jstring tag, jint level)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tag == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* chars = env-&gt;GetStringUTFChars(tag, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!chars) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jboolean result = isLoggable(chars, level);</span><br><span class="line"></span><br><span class="line">    env-&gt;ReleaseStringUTFChars(tag, chars);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">isLoggable</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* tag, jint level)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> __android_log_is_loggable(level, tag, ANDROID_LOG_INFO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  二、查看android_util_Log_println_native函数的实现，最后调用的是__android_log_buf_write函数，如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * In class android.util.Log:</span></span><br><span class="line"><span class="comment"> *  public static native int println_native(int buffer, int priority, String tag, String msg)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">android_util_Log_println_native</span><span class="params">(JNIEnv* env, jobject clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint bufID, jint priority, jstring tagObj, jstring msgObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* tag = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* msg = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgObj == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        jniThrowNullPointerException(env, <span class="string">"println needs a message"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufID &lt; <span class="number">0</span> || bufID &gt;= LOG_ID_MAX) &#123;</span><br><span class="line">        jniThrowNullPointerException(env, <span class="string">"bad bufID"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tagObj != <span class="literal">NULL</span>)</span><br><span class="line">        tag = env-&gt;GetStringUTFChars(tagObj, <span class="literal">NULL</span>);<span class="comment">//取出tag</span></span><br><span class="line">    msg = env-&gt;GetStringUTFChars(msgObj, <span class="literal">NULL</span>);<span class="comment">//取出msg</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> res = __android_log_buf_write(bufID, (android_LogPriority)priority, tag, msg);<span class="comment">//往缓冲区写</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tag != <span class="literal">NULL</span>)</span><br><span class="line">        env-&gt;ReleaseStringUTFChars(tagObj, tag);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(msgObj, msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://img-blog.csdn.net/20170103194253919" target="_blank" rel="noopener">log_JNI-liblog-lod流程图</a></p>
<p> 三、查看android_util_Log_logger_entry_max_payload_native函数，最后取的是LOGGER_ENTRY_MAX_PAYLOAD的值.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * In class android.util.Log:</span></span><br><span class="line"><span class="comment"> *  private static native int logger_entry_max_payload_native()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">android_util_Log_logger_entry_max_payload_native</span><span class="params">(JNIEnv* env ATTRIBUTE_UNUSED,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                             jobject clazz ATTRIBUTE_UNUSED)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;jint&gt;(LOGGER_ENTRY_MAX_PAYLOAD);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 本文主要研究log相关的，所以重点还是只研究liblog这个库文件，具体见下一节.</p>
<h1 id="运行时库层liblog模块log功能解析"><a href="#运行时库层liblog模块log功能解析" class="headerlink" title="运行时库层liblog模块log功能解析"></a>运行时库层liblog模块log功能解析</h1><p> <strong>liblog</strong>:system/core/liblog<br> 功能：Android Internal NDK logger interfaces  Android内部的NDK logger模块的接口.提供一些公共函数接口供其他模块调用,<br> 目前了解到的一下模块需要用到liblog库：<br> • logd<br> • logcat<br> • system/core/libvndksupport: VNDK -vendor NDK 各个芯片厂商自定义的NDK<br> • frameworks/native/services/audiomanager<br> 等等模块都需要用liblog库文件来处理log.</p>
<p> 阅读README文件.如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">DESCRIPTION</span><br><span class="line">       liblog  represents  an interface to the volatile Android Logging system</span><br><span class="line">       <span class="keyword">for</span> NDK (Native) applications  and  libraries.  Interfaces  <span class="keyword">for</span>  either</span><br><span class="line">       writing  or reading logs.  The <span class="built_in">log</span> buffers are divided up <span class="keyword">in</span> Main, Sys‐</span><br><span class="line">       tem, Radio and Events sub-logs.</span><br><span class="line">       liblog是Android Log系统用于NDK应用或者lib库的接口,此接口提供了读和写<span class="built_in">log</span>的方法,<span class="built_in">log</span></span><br><span class="line">       缓冲区被分为类Main.system.radio.event等几个部分.</span><br><span class="line"></span><br><span class="line">       The logging interfaces are a series of macros,  all  of  <span class="built_in">which</span>  can  be</span><br><span class="line">       overridden individually <span class="keyword">in</span> order to control the verbosity of the appli‐</span><br><span class="line">       cation or library.  [ASR]LOG[VDIWE] calls are used  to  <span class="built_in">log</span>  to  BAsic,</span><br><span class="line">       System or Radio sub-logs <span class="keyword">in</span> either the Verbose, Debug, Info, Warning or</span><br><span class="line">       Error priorities.  [ASR]LOG[VDIWE]_IF calls are used  to  perform  thus</span><br><span class="line">       based  on a condition being <span class="literal">true</span>.  IF_ALOG[VDIWE] calls are <span class="literal">true</span> <span class="keyword">if</span> the</span><br><span class="line">       current LOG_TAG is enabled at the specified priority.  LOG_ALWAYS_FATAL</span><br><span class="line">       is  used to ALOG a message, <span class="keyword">then</span> <span class="built_in">kill</span> the process.  LOG_FATAL call is a</span><br><span class="line">       variant of LOG_ALWAYS_FATAL,  only  enabled  <span class="keyword">in</span>  engineering,  and  not</span><br><span class="line">       release builds.  ALOG_ASSERT is used to ALOG a message <span class="keyword">if</span> the condition</span><br><span class="line">       is  <span class="literal">false</span>;   the   condition   is   part   of   the   logged   message.</span><br><span class="line">       LOG_EVENT_(INT|LONG)  is  used  to  drop binary content into the Events</span><br><span class="line">       sub-log.</span><br><span class="line">       译:<span class="built_in">log</span>接口就是一系列的宏,在每个应用或者库中为了更详细的控制<span class="built_in">log</span>的输出,在各个应用或者库中</span><br><span class="line">       可以对这些宏进行单独的覆盖处理.</span><br><span class="line">       [ASR]LOG[VDIWE] 类型：如ALOGV(format, ...).可以用于打印main,system,radio类</span><br><span class="line">       的各种级别的<span class="built_in">log</span>.</span><br><span class="line">       [ASR]LOG[VDIWE]_IF 类型：如ALOGV_IF(cond, format, ...).可以用于打印满足cond</span><br><span class="line">       条件的时候输出<span class="built_in">log</span>.</span><br><span class="line">       IF_ALOG[VDIWE] 类型:如IF_ALOGD().当当前的LOG_TAG在特殊优先级下运行使用时,可以正</span><br><span class="line">       常使用.</span><br><span class="line">       LOG_ALWAYS_FATAL 类型：如LOG_ALWAYS_FATAL(format, ...).用于打印一条<span class="built_in">kill</span>进程</span><br><span class="line">       的<span class="built_in">log</span>.</span><br><span class="line">       LOG_FATAL 类型：如LOG_FATAL(format, ...).与LOG_ALWAYS_FATAL一样的功能,不过它</span><br><span class="line">       只在Eng版本中打印,release版本中不会打印.</span><br><span class="line">       ALOG_ASSERT 类型:如ALOG_ASSERT(cond, format, ...).当cond不满足的时候打印.</span><br><span class="line">       LOG_EVENT_INT 类型：如LOG_EVENT_INT(tag,value).用于打印二进制内容到Eventlog中</span><br><span class="line"></span><br><span class="line">       The <span class="built_in">log</span> reading interfaces permit opening the  logs  either  singly  or</span><br><span class="line">       multiply,  retrieving  a  <span class="built_in">log</span>  entry  at  a  time <span class="keyword">in</span> time sorted order,</span><br><span class="line">       optionally limited to a specific pid and tail of the <span class="built_in">log</span>(s) and finally</span><br><span class="line">       a  call closing the logs.  A single <span class="built_in">log</span> can be opened with android_log‐</span><br><span class="line">       ger_list_open;  or  multiple  logs  can  be  opened  with  android_log‐</span><br><span class="line">       ger_list_alloc,  calling  <span class="keyword">in</span>  turn the android_logger_open <span class="keyword">for</span> each <span class="built_in">log</span></span><br><span class="line">       id.  Each entry can be retrieved  with  android_logger_list_read.   The</span><br><span class="line">       <span class="built_in">log</span>(s) can be closed with android_logger_list_free.  The logs should be</span><br><span class="line">       opened  with an  ANDROID_LOG_RDONLY  mode.   ANDROID_LOG_NONBLOCK  mode</span><br><span class="line">       will report when the  <span class="built_in">log</span> reading is <span class="keyword">done</span> with an  EAGAIN  error <span class="built_in">return</span></span><br><span class="line">       code,  otherwise the  android_logger_list_read  call will block <span class="keyword">for</span> new</span><br><span class="line">       entries.</span><br><span class="line">       译:<span class="built_in">log</span>的reading接口可以读取通过时间排序收到的一条<span class="built_in">log</span>.</span><br><span class="line">       单条<span class="built_in">log</span>可以通过 android_logger_list_open 函数打开,多条<span class="built_in">log</span>可以通过android_log‐</span><br><span class="line">       ger_list_alloc 调用 android_logger_list_open 打开.每条<span class="built_in">log</span>都可以被 android_l-</span><br><span class="line">       ogger_list_read 函数检索. 可以通过 android_logger_list_free 关闭回收. <span class="built_in">log</span>必须</span><br><span class="line">       在 ANDROID_LOG_RDONLY 的只读模式打开. 当<span class="built_in">log</span>读取完成后 ANDROID_LOG_NONBLOCK 模</span><br><span class="line">       式将会以 EAGAIN 形式返回,否则 android_logger_list_read 将会阻止读取新的<span class="built_in">log</span>.</span><br><span class="line"></span><br><span class="line">       The  ANDROID_LOG_WRAP  mode flag to the  android_logger_list_alloc_time</span><br><span class="line">       signals  logd to quiesce  the reader until the buffer is about to prune</span><br><span class="line">       at the start time <span class="keyword">then</span> proceed to dumping content.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       The  ANDROID_LOG_PSTORE mode flag to the android_logger_open is used to</span><br><span class="line">       switch from the active logs to the persistent logs from before the last</span><br><span class="line">       reboot.</span><br><span class="line">       译:ANDROID_LOG_PSTORE 模式标识用于从上次重启之后使用 android_logger_open 打开</span><br><span class="line">       <span class="built_in">log</span>从 active logs 切换到 persistent logs.</span><br><span class="line"></span><br><span class="line">       The value returned by android_logger_open can be used as a parameter to</span><br><span class="line">       the  android_logger_clear  <span class="keyword">function</span> to empty the sub-log.  It is recom‐</span><br><span class="line">       mended to only open <span class="built_in">log</span> ANDROID_LOG_WRONLY <span class="keyword">in</span> that <span class="keyword">case</span>.</span><br><span class="line">       译:android_logger_open 函数的返回值可以作为 android_logger_clear 函数的参数来</span><br><span class="line">       清空打开的<span class="built_in">log</span>信息.仅推荐在 ANDROID_LOG_WRONLY 只写模式下打开<span class="built_in">log</span>时使用.</span><br><span class="line"></span><br><span class="line">       The value returned by android_logger_open can be used as a parameter to</span><br><span class="line">       the android_logger_get_log_(size|readable_size|version) to retrieve the</span><br><span class="line">       sub-log maximum size, readable size and <span class="built_in">log</span> buffer format protocol ver‐</span><br><span class="line">       sion  respectively.  android_logger_get_id returns the id that was used</span><br><span class="line">       when  opening  the  sub-log.    It  is  recommended  to  open  the  <span class="built_in">log</span></span><br><span class="line">       ANDROID_LOG_RDONLY <span class="keyword">in</span> these cases.</span><br><span class="line">       译:android_logger_open 函数的返回值可以作为 android_logger_get_log_ 函数的参</span><br><span class="line">       数.仅推荐在 ANDROID_LOG_RDONLY 只读模式下启动.</span><br><span class="line"></span><br><span class="line">       android_set_log_transport()  selects  transport  filters.  Argument  is</span><br><span class="line">       either LOGGER_DEFAULT, LOGGER_LOGD, LOGGER_NULL or LOGGER_LOCAL. Log to</span><br><span class="line">       logger daemon <span class="keyword">for</span> default or logd, drop contents on floor,  or <span class="built_in">log</span> into</span><br><span class="line">       <span class="built_in">local</span>   memory   respectively.       Both   android_set_log_transport()</span><br><span class="line">       and android_get_log_transport() <span class="built_in">return</span> the current  transport mask,  or</span><br><span class="line">       a negative errno <span class="keyword">for</span> any problems.</span><br><span class="line">       译:</span><br><span class="line"></span><br><span class="line">ERRORS</span><br><span class="line">       If messages fail, a negative error code will be returned to the <span class="built_in">caller</span>.</span><br><span class="line"></span><br><span class="line">       The -ENOTCONN <span class="built_in">return</span> code indicates that the logger daemon is stopped.</span><br><span class="line"></span><br><span class="line">       The  -EBADF <span class="built_in">return</span> code indicates that the <span class="built_in">log</span> access point can not be</span><br><span class="line">       opened, or the <span class="built_in">log</span> buffer id is out of range.</span><br><span class="line"></span><br><span class="line">       For the  -EAGAIN  <span class="built_in">return</span> code,  this means that the logging message was</span><br><span class="line">       temporarily backed-up either because of Denial Of Service (DOS) logging</span><br><span class="line">       pressure from some chatty application or service <span class="keyword">in</span> the Android system,</span><br><span class="line">       or <span class="keyword">if</span> too small of a value is <span class="built_in">set</span> <span class="keyword">in</span> /proc/sys/net/unix/max_dgram_qlen.</span><br><span class="line">       To aid <span class="keyword">in</span> diagnosing the occurence of this,  a binary event from liblog</span><br><span class="line">       will be sent to the  <span class="built_in">log</span>  daemon  once a  new  message  can get through</span><br><span class="line">       indicating how many  messages were  dropped  as a result.   Please take</span><br><span class="line">       action to resolve the structural problems at the <span class="built_in">source</span>.</span><br><span class="line"></span><br><span class="line">       It is generally not advised <span class="keyword">for</span> the <span class="built_in">caller</span> to retry the  -EAGAIN <span class="built_in">return</span></span><br><span class="line">       code as  this  will  only  make the  problem(s)  worse  and  cause your</span><br><span class="line">       application to temporarily drop to the  logger daemon  priority,  BATCH</span><br><span class="line">       scheduling policy and background task cgroup. If you require a group of</span><br><span class="line">       messages to be passed atomically,  merge  them  into  one  message with</span><br><span class="line">       embedded newlines to the maximum length LOGGER_ENTRY_MAX_PAYLOAD.</span><br><span class="line"></span><br><span class="line">       Other <span class="built_in">return</span> codes  from  writing operation can be returned.  Since the</span><br><span class="line">       library retries on EINTR, -EINTR should never be returned.</span><br></pre></td></tr></table></figure></p>
<p> 注意：下面这三个目录中的代码<br>    system/core/include/android<br>    system/core/include/log<br>    system/core/include/private<br>    和 liblog模块中下面三个目录下面的代码一模一样<br>    system/core/liblog/include/android<br>    system/core/liblog/include/log<br>    system/core/liblog/include/private<br>    同时也和system/core/liblog/include_vndk一模一样，<br>    怀疑这三个地方的文件是<strong>软连接</strong>.我们到system/core/include/android/log.h用ls -al查看，果然是软连接到了system/core/liblog/include/log/log.h文件.</p>
<p>   Q:为何要做这三个目录的软连接？</p>
<p> 我们从system/core/liblog/include/android/log.h里面看看关于liblog的一些说明.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/******************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * IMPORTANT NOTICE:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   This file is part of Android's set of stable system headers</span></span><br><span class="line"><span class="comment"> *   exposed by the Android NDK (Native Development Kit) since</span></span><br><span class="line"><span class="comment"> *   platform release 1.5</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   Third-party source AND binary code relies on the definitions</span></span><br><span class="line"><span class="comment"> *   here to be FROZEN ON ALL UPCOMING PLATFORM RELEASES.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   - DO NOT MODIFY ENUMS (EXCEPT IF YOU ADD NEW 32-BIT VALUES)</span></span><br><span class="line"><span class="comment"> *   - DO NOT MODIFY CONSTANTS OR FUNCTIONAL MACROS</span></span><br><span class="line"><span class="comment"> *   - DO NOT CHANGE THE SIGNATURE OF FUNCTIONS IN ANY WAY</span></span><br><span class="line"><span class="comment"> *   - DO NOT CHANGE THE LAYOUT OR SIZE OF STRUCTURES</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Support routines to send messages to the Android in-kernel log buffer,</span></span><br><span class="line"><span class="comment"> * which can later be accessed through the 'logcat' utility.</span></span><br><span class="line"><span class="comment"> * //liblog支持往kernel的log缓冲区发送消息，这些消息可以通过logcat工具来进行读取.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Each log message must have</span></span><br><span class="line"><span class="comment"> *   - a priority</span></span><br><span class="line"><span class="comment"> *   - a log tag</span></span><br><span class="line"><span class="comment"> *   - some text</span></span><br><span class="line"><span class="comment"> * //每条log信息必须由以下三部分组成</span></span><br><span class="line"><span class="comment"> * // a)优先级</span></span><br><span class="line"><span class="comment"> * // b)tag 标签</span></span><br><span class="line"><span class="comment"> * // c)text 内容</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The tag normally corresponds to the component that emits the log message,</span></span><br><span class="line"><span class="comment"> * and should be reasonably small.</span></span><br><span class="line"><span class="comment"> * //Tag主要用于标识log发生的组件或者地方，不易过长.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Log message text may be truncated to less than an implementation-specific</span></span><br><span class="line"><span class="comment"> * limit (e.g. 1023 characters max).</span></span><br><span class="line"><span class="comment"> * //log消息文本可能会被截断为小于规定的长度,比如若规定最大字符串长度为1023个字节，超过的话，可能会被截断.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that a newline character ("\n") will be appended automatically to your</span></span><br><span class="line"><span class="comment"> * log message, if not already there. It is not possible to send several</span></span><br><span class="line"><span class="comment"> * messages and have them appear on a single line in logcat.</span></span><br><span class="line"><span class="comment"> * //如果没有换行符的话，会自动进行换行，不可能在单行中显示多条log信息.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * PLEASE USE LOGS WITH MODERATION://请尽量避免打log</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  - Sending log messages eats CPU and slow down your application and the</span></span><br><span class="line"><span class="comment"> *    system.//发送log信息将消耗CPU而且会降低应用的性能.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  - The circular log buffer is pretty small (&lt;64KB), sending many messages</span></span><br><span class="line"><span class="comment"> *    might push off other important log messages from the rest of the system.</span></span><br><span class="line"><span class="comment"> *    //log的缓冲区非常小，小于64KB，所以如果频繁发送太多的消息，可能会冲掉之前的重要消息.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  - In release builds, only send log messages to account for exceptional</span></span><br><span class="line"><span class="comment"> *    conditions.//在release版本中，仅发送特殊限定的一些log</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> These functions MUST be implemented by /system/lib/liblog.so</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></p>
<h1 id="logd模块功能解析"><a href="#logd模块功能解析" class="headerlink" title="logd模块功能解析"></a>logd模块功能解析</h1><p> logd 是Android L版本提出来的概念，其作用有：<br> 一：与liblog交互，保存Android运行期间的log.在Android L之前，log由kernel的ring buffer 保存，在Android L之后，log保存在用户空间。<br> 二：与logcat交互，接收从logcat传来的命令，将log从logd传给logcat.</p>
<p> logd代码位置：system/core/logd</p>
<p> logd模块相关的prop属性值<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h2 id="logd-进程的启动"><a href="#logd-进程的启动" class="headerlink" title="logd 进程的启动"></a>logd 进程的启动</h2><p> 参考资料:<br> <a href="https://blog.csdn.net/yinjian1013/article/details/78261527" target="_blank" rel="noopener">android logd 原理及实现</a><br> <a href="https://blog.csdn.net/koffuxu/article/details/53893297" target="_blank" rel="noopener">Android L日志系统1——logd</a><br> <a href="https://zhuanlan.zhihu.com/p/24372024" target="_blank" rel="noopener">Android6.0 Log的工作机制</a></p>
<h1 id="Logcat源码解析"><a href="#Logcat源码解析" class="headerlink" title="Logcat源码解析"></a>Logcat源码解析</h1><p> logcat源码位于：system/core/logcat/目录<br> Logcat模块代码结构如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">logcat</span><br><span class="line">  └── inclide</span><br><span class="line">  |      └── <span class="built_in">log</span></span><br><span class="line">  |           └── getopt.h</span><br><span class="line">  |           └── log.h</span><br><span class="line">  └── Android.mk</span><br><span class="line">  └── event.logtags</span><br><span class="line">  └── getopt_long.cpp</span><br><span class="line">  └── logcat_main.cpp</span><br><span class="line">  └── logcat_system.cpp</span><br><span class="line">  └── logcat.cpp</span><br><span class="line">  └── logcatd_main.cpp</span><br><span class="line">  └── logcatd.rc</span><br><span class="line">  └── logpersist</span><br><span class="line">  └── .clang.format</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">logcat</span><br><span class="line">├── Android.mk</span><br><span class="line">├── event.logtags</span><br><span class="line">├── getopt_long.cpp</span><br><span class="line">├── include</span><br><span class="line">│   └── <span class="built_in">log</span></span><br><span class="line">│       ├── getopt.h</span><br><span class="line">│       └── logcat.h</span><br><span class="line">├── logcat.cpp</span><br><span class="line">├── logcatd_main.cpp</span><br><span class="line">├── logcatd.rc</span><br><span class="line">├── logcat_main.cpp</span><br><span class="line">├── logcat_system.cpp</span><br><span class="line">├── logpersist</span><br><span class="line">├── MODULE_LICENSE_APACHE2</span><br><span class="line">├── NOTICE</span><br><span class="line">└── tests</span><br><span class="line">    ├── Android.mk</span><br><span class="line">    ├── exec_benchmark.cpp</span><br><span class="line">    ├── liblogcat_test.cpp</span><br><span class="line">    ├── logcat_benchmark.cpp</span><br><span class="line">    ├── logcatd_test.cpp</span><br><span class="line">    └── logcat_test.cpp</span><br></pre></td></tr></table></figure>
<p> Q: 为何可以用adb 后面带 logcat 的方式来抓取log？<br>  <a href="https://blog.csdn.net/u010223349/article/details/41120255" target="_blank" rel="noopener">ADB实现解析</a><br>  <a href="https://blog.csdn.net/ysh149216447/article/details/53334015" target="_blank" rel="noopener">Android adb实现原理</a></p>
<h2 id="模块文件分析"><a href="#模块文件分析" class="headerlink" title="模块文件分析"></a>模块文件分析</h2><p> 1) Android.mk<br> 从Android.mk文件来看，编译生成了logcat和logcatd两个可执行bin文件，一个liblogcat共享库文件，和一个logpersist.start文件<br> logcat 作用：  入口函数是logcat_main.cpp<br> logcatd 作用: 用于保存log的服务，入口函数是logcatd_main.cpp<br> liblogcat 作用: 给logcat test使用<br> logpersist.start : 依据logpersist会在system/bin目录，生成logpersist.start logpersist.stop logpersist.cat </p>
<p> 2)event.logtags<br> 定义了一些Event log</p>
<p> 3)getopt_long.cpp<br> 命令行解析函数，支持长选项解析，用于解析logcat命令的辅助工具.</p>
<p> 4)logcat_main.cpp</p>
<p> 参考资料<br> <a href="https://blog.csdn.net/luoshengyang/article/details/6606957" target="_blank" rel="noopener">Android日志系统Logcat源代码简要分析</a></p>
<h1 id="Logwrapper-模块解析"><a href="#Logwrapper-模块解析" class="headerlink" title="Logwrapper 模块解析"></a>Logwrapper 模块解析</h1><h1 id="Logger-驱动模块解析"><a href="#Logger-驱动模块解析" class="headerlink" title="Logger 驱动模块解析"></a>Logger 驱动模块解析</h1><p> 在用户态中的log是由logger驱动实现,使用logcat工具完成log的查看和收集.本节将关注Logger驱动的实现原理.<br> Logger驱动程序主要由两个文件构成，分别是：<br> kernel/drivers/staging/android/logger.c<br> kernel/drivers/staging/android/logger.h</p>
<h2 id="Logger系统数据结构"><a href="#Logger系统数据结构" class="headerlink" title="Logger系统数据结构"></a>Logger系统数据结构</h2><p> 先来看一下logger.h头文件的内容：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _LINUX_LOGGER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _LINUX_LOGGER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct user_logger_entry_compat - defines a single entry that is given to a logger</span></span><br><span class="line"><span class="comment"> * @len:	The length of the payload  //有效负载长度</span></span><br><span class="line"><span class="comment"> * @__pad:	Two bytes of padding that appear to be required //两个字节的空格</span></span><br><span class="line"><span class="comment"> * @pid:	The generating process' process ID  //进程ID</span></span><br><span class="line"><span class="comment"> * @tid:	The generating process' thread ID   //线程ID</span></span><br><span class="line"><span class="comment"> * @sec:	The number of seconds that have elapsed since the Epoch  //秒数</span></span><br><span class="line"><span class="comment"> * @nsec:	The number of nanoseconds that have elapsed since @sec   //纳秒数</span></span><br><span class="line"><span class="comment"> * @msg:	The message that is to be logged  //log的内容</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The userspace structure for version 1 of the logger_entry ABI.</span></span><br><span class="line"><span class="comment"> * This structure is returned to userspace unless the caller requests</span></span><br><span class="line"><span class="comment"> * an upgrade to a newer ABI version.</span></span><br><span class="line"><span class="comment"> * 用户空间中一条log的结构</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_logger_entry_compat</span> &#123;</span></span><br><span class="line">	__u16		len;</span><br><span class="line">	__u16		__pad;</span><br><span class="line">	__s32		pid;</span><br><span class="line">	__s32		tid;</span><br><span class="line">	__s32		sec;</span><br><span class="line">	__s32		nsec;</span><br><span class="line">	<span class="keyword">char</span>		msg[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct logger_entry - defines a single entry that is given to a logger</span></span><br><span class="line"><span class="comment"> * @len:	The length of the payload  //有效负载长度</span></span><br><span class="line"><span class="comment"> * @hdr_size:	sizeof(struct logger_entry_v2) //</span></span><br><span class="line"><span class="comment"> * @pid:	The generating process' process ID //进程ID</span></span><br><span class="line"><span class="comment"> * @tid:	The generating process' thread ID // 线程ID</span></span><br><span class="line"><span class="comment"> * @sec:	The number of seconds that have elapsed since the Epoch //秒</span></span><br><span class="line"><span class="comment"> * @nsec:	The number of nanoseconds that have elapsed since @sec //纳秒</span></span><br><span class="line"><span class="comment"> * @euid:	Effective UID of logger //User Identifier 用户ID</span></span><br><span class="line"><span class="comment"> * @msg:	The message that is to be logged</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The structure for version 2 of the logger_entry ABI.</span></span><br><span class="line"><span class="comment"> * This structure is returned to userspace if ioctl(LOGGER_SET_VERSION)</span></span><br><span class="line"><span class="comment"> * is called with version &gt;= 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">logger_entry</span> &#123;</span></span><br><span class="line">	__u16		len;</span><br><span class="line">	__u16		hdr_size;</span><br><span class="line">	__s32		pid;</span><br><span class="line">	__s32		tid;</span><br><span class="line">	__s32		sec;</span><br><span class="line">	__s32		nsec;</span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;</span><br><span class="line">	<span class="keyword">char</span>		msg[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_LOG_RADIO	<span class="meta-string">"log_radio"</span>	<span class="comment">/* radio-related messages */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_LOG_EVENTS	<span class="meta-string">"log_events"</span>	<span class="comment">/* system/hardware events */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_LOG_SYSTEM	<span class="meta-string">"log_system"</span>	<span class="comment">/* system/framework messages */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_LOG_MAIN		<span class="meta-string">"log_main"</span>	<span class="comment">/* everything else */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_ENTRY_MAX_PAYLOAD	4076 <span class="comment">//每条日志记录最大长度4076字节</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __LOGGERIO	0xAE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_GET_LOG_BUF_SIZE		_IO(__LOGGERIO, 1) <span class="comment">/* size of log */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_GET_LOG_LEN		_IO(__LOGGERIO, 2) <span class="comment">/* used log len */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_GET_NEXT_ENTRY_LEN	_IO(__LOGGERIO, 3) <span class="comment">/* next entry len */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_FLUSH_LOG		_IO(__LOGGERIO, 4) <span class="comment">/* flush log */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_GET_VERSION		_IO(__LOGGERIO, 5) <span class="comment">/* abi version */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGGER_SET_VERSION		_IO(__LOGGERIO, 6) <span class="comment">/* abi version */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _LINUX_LOGGER_H */</span></span></span><br></pre></td></tr></table></figure></p>
<p> 我们看到有两个结构体 user_logger_entry_compat 和 logger_entry，均用来描述一条Log记录.</p>
<p> struct user_logger_entry_compat 是一个用于描述一条Log记录的结构体。len成员变量记录了这条记录的有效负载的长度，有效负载指定的日志记录本身的长度，但是不包括用于描述这个记录的struct logger_entry结构体。回忆一下我们调用android.util.Log接口来使用日志系统时，会指定日志的优先级别Priority、Tag字符串以及Msg字符串，Priority + Tag + Msg三者内容的长度加起来就是记录的有效负载长度了。__pad成员变量是用来对齐结构体的。pid和tid成员变量分别用来记录是哪条进程和线程写入了这条记录。sec和nsec成员变量记录日志写的时间。msg成员变量记录的就有效负载的内容了，它的大小由len成员变量来确定。</p>
<p> #define LOGGER_ENTRY_MAX_PAYLOAD    4076 表示每条日志记录最大长度4076字节=(LOGGER_ENTRY_MAX_LEN - sizeof(struct logger_entry))</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct logger_log - represents a specific log, such as 'main' or 'radio'</span></span><br><span class="line"><span class="comment"> * @buffer:	The actual ring buffer</span></span><br><span class="line"><span class="comment"> * @misc:	The "misc" device representing the log</span></span><br><span class="line"><span class="comment"> * @wq:		The wait queue for @readers</span></span><br><span class="line"><span class="comment"> * @readers:	This log's readers</span></span><br><span class="line"><span class="comment"> * @mutex:	The mutex that protects the @buffer</span></span><br><span class="line"><span class="comment"> * @w_off:	The current write head offset</span></span><br><span class="line"><span class="comment"> * @head:	The head, or location that readers start reading at.</span></span><br><span class="line"><span class="comment"> * @size:	The size of the log</span></span><br><span class="line"><span class="comment"> * @logs:	The list of log channels</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This structure lives from module insertion until module removal, so it does</span></span><br><span class="line"><span class="comment"> * not need additional reference counting. The structure is protected by the</span></span><br><span class="line"><span class="comment"> * mutex 'mutex'.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">logger_log</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>		*buffer;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span>	<span class="title">misc</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span>	wq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">readers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">mutex</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span>			w_off;</span><br><span class="line">	<span class="keyword">size_t</span>			head;</span><br><span class="line">	<span class="keyword">size_t</span>			size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">logs</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">LIST_HEAD</span><span class="params">(log_list)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct logger_reader - a logging device open for reading</span></span><br><span class="line"><span class="comment"> * @log:	The associated log</span></span><br><span class="line"><span class="comment"> * @list:	The associated entry in @logger_log's list</span></span><br><span class="line"><span class="comment"> * @r_off:	The current read head offset.</span></span><br><span class="line"><span class="comment"> * @r_all:	Reader can read all entries</span></span><br><span class="line"><span class="comment"> * @r_ver:	Reader ABI version</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This object lives from open to release, so we don't need additional</span></span><br><span class="line"><span class="comment"> * reference counting. The structure is protected by log-&gt;mutex.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">logger_reader</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">logger_log</span>	*<span class="title">log</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">list</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span>			r_off;</span><br><span class="line">	<span class="keyword">bool</span>			r_all;</span><br><span class="line">	<span class="keyword">int</span>			r_ver;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>   结构体struct logger_log就是真正用来保存日志的地方了。buffer成员变量变是用保存日志信息的内存缓冲区，它的大小由size成员变量确定。从misc成员变量可以看出，logger驱动程序使用的设备属于misc类型的设备，通过在Android模拟器上执行cat /proc/devices命令（可参考在Ubuntu上下载、编译和安装Android最新内核源代码（Linux Kernel）一文），可以看出，misc类型设备的主设备号是10。关于主设备号的相关知识，可以参考Android学习启动篇一文中提到的Linux Driver Development一书。wq成员变量是一个等待队列，用于保存正在等待读取日志的进程。readers成员变量用来保存当前正在读取日志的进程，正在读取日志的进程由结构体logger_reader来描述。mutex成员变量是一个互斥量，用来保护log的并发访问。可以看出，这里的日志系统的读写问题，其实是一个生产者-消费者的问题，因此，需要互斥量来保护log的并发访问。 w_off成员变量用来记录下一条日志应该从哪里开始写。head成员变量用来表示打开日志文件中，应该从哪一个位置开始读取日志</p>
<p>   结构体struct logger_reader用来表示一个读取日志的进程，log成员变量指向要读取的日志缓冲区。list成员变量用来连接其它读者进程。r_off成员变量表示当前要读取的日志在缓冲区中的位置。</p>
<p>   struct logger_log结构体中用于保存日志信息的内存缓冲区buffer是一个循环使用的环形缓冲区，缓冲区中保存的内容是以struct logger_entry为单位的，每个单位的组成为：</p>
<pre><code>struct logger_entry | priority | tag | msg

由于是内存缓冲区buffer是一个循环使用的环形缓冲区，给定一个偏移值，它在buffer中的位置由下logger_offset来确定：

#define logger_offset(n)          ((n) &amp; (log-&gt;size - 1))
</code></pre><h2 id="Logger模块的初始化过程分析"><a href="#Logger模块的初始化过程分析" class="headerlink" title="Logger模块的初始化过程分析"></a>Logger模块的初始化过程分析</h2><p> 继续看logger.c文件，定义了三个日志设备：<br> 待补充</p>
<h2 id="日志系统读取"><a href="#日志系统读取" class="headerlink" title="日志系统读取"></a>日志系统读取</h2><p> 待补充</p>
<h2 id="日志系统写入"><a href="#日志系统写入" class="headerlink" title="日志系统写入"></a>日志系统写入</h2><p> 待补充</p>
<h1 id="Eventlog解析"><a href="#Eventlog解析" class="headerlink" title="Eventlog解析"></a>Eventlog解析</h1><p> 在调试分析Android的过程中，比较常用的地查看EventLog，非常简洁明了地展现当前Activity各种状态,以及Window状态等，看完本节之后，如果在某个模块调试过程中，有几个比较关键的状态值需要关注，也可以自己定义一些Event事件，最后从eventlog中获取状态值.</p>
<p> 本节将从EventLog在代码中的使用开始解析EventLog的流程.</p>
<h2 id="Eventlog的使用"><a href="#Eventlog的使用" class="headerlink" title="Eventlog的使用"></a>Eventlog的使用</h2><p> 在代码中搜索*.logtags文件，结果如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">./system/bt/EventLogTags.logtags</span><br><span class="line">./system/core/logd/event.logtags</span><br><span class="line">./system/core/libsysutils/EventLogTags.logtags</span><br><span class="line">./system/core/liblog/event.logtags</span><br><span class="line">./system/core/logcat/event.logtags</span><br><span class="line">./system/core/storaged/EventLogTags.logtags</span><br><span class="line">./packages/apps/TimeZoneUpdater/src/main/com/android/timezone/updater/EventLogTags.logtags</span><br><span class="line">./packages/apps/QuickSearchBox/src/com/android/quicksearchbox/EventLogTags.logtags</span><br><span class="line">./packages/apps/Settings/src/com/android/settings/EventLogTags.logtags</span><br><span class="line">./packages/services/Telephony/src/com/android/phone/EventLogTags.logtags</span><br><span class="line">./packages/providers/CalendarProvider/src/com/android/providers/calendar/EventLogTags.logtags</span><br><span class="line">./packages/providers/ContactsProvider/src/com/android/providers/contacts/EventLogTags.logtags</span><br><span class="line">./frameworks/base/packages/SystemUI/src/com/android/systemui/EventLogTags.logtags</span><br><span class="line">./frameworks/base/packages/SettingsProvider/src/com/android/providers/settings/EventLogTags.logtags</span><br><span class="line">./frameworks/base/services/core/java/com/android/server/am/EventLogTags.logtags</span><br><span class="line">./frameworks/base/services/core/java/com/android/server/EventLogTags.logtags</span><br><span class="line">./frameworks/base/core/java/com/android/internal/logging/EventLogTags.logtags</span><br><span class="line">./frameworks/base/core/java/android/content/EventLogTags.logtags</span><br><span class="line">./frameworks/base/core/java/android/app/admin/SecurityLogTags.logtags</span><br><span class="line">./frameworks/base/core/java/android/speech/tts/EventLogTags.logtags</span><br><span class="line">./frameworks/base/core/java/android/net/EventLogTags.logtags</span><br><span class="line">./frameworks/base/core/java/android/webkit/EventLogTags.logtags</span><br><span class="line">./frameworks/<span class="keyword">native</span>/services/surfaceflinger/EventLog/EventLogTags.logtags</span><br><span class="line">./frameworks/ex/common/java/com/android/common/GoogleLogTags.logtags</span><br><span class="line">./frameworks/opt/telephony/src/java/com/android/internal/telephony/EventLogTags.logtags</span><br></pre></td></tr></table></figure></p>
<p> 从上面的结果可以看到，有很多的模块都有使用EventLog,在这里对于Java侧的SystemUI中EventLog为例进行剖析，对于C/C++层的EventLog留待后续分析.<br> 先来看frameworks/base/packages/SystemUI/src/com/android/systemui/EventLogTags.logtags的部分代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># See system/core/logcat/event.logtags for a description of the format of this file.</span></span><br><span class="line"></span><br><span class="line">option java_package com.android.systemui;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"><span class="comment"># PhoneStatusBar.java</span></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line">36000 sysui_statusbar_touch (<span class="built_in">type</span>|1),(x|1),(y|1),(disable1|1),(disable2|1)</span><br><span class="line">36001 sysui_heads_up_status (key|3),(visible|1)</span><br><span class="line">36002 sysui_fullscreen_notification (key|3)</span><br><span class="line">36003 sysui_heads_up_escalation (key|3)</span><br><span class="line"><span class="comment"># sysui_status_bar_state: Logged whenever the status bar / keyguard state changes</span></span><br><span class="line"><span class="comment">## state: 0: SHADE, 1: KEYGUARD, 2: SHADE_LOCKED</span></span><br><span class="line"><span class="comment">## keyguardShowing: 1: Keyguard shown to the user (or keyguardOccluded)</span></span><br><span class="line"><span class="comment">## keyguardOccluded: 1: Keyguard active, but another activity is occluding it</span></span><br><span class="line"><span class="comment">## bouncerShowing: 1: Bouncer currently shown to the user</span></span><br><span class="line"><span class="comment">## secure: 1: The user has set up a secure unlock method (PIN, password, etc.)</span></span><br><span class="line"><span class="comment">## currentlyInsecure: 1: No secure unlock method set up (!secure), or trusted environment (TrustManager)</span></span><br><span class="line">36004 sysui_status_bar_state (state|1),(keyguardShowing|1),(keyguardOccluded|1),(bouncerShowing|1),(secure|1),(currentlyInsecure|1)</span><br></pre></td></tr></table></figure></p>
<p> 从第一行我们看到在system/core/logcat/event.logtags中有EventLog格式的描述，我们到system/core/logcat/event.logtags看看,event.logtags自身也是一个EventLog文件，但是在此文件的开头和结尾，有对logtags格式的文件格式进行了描述，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The entries in this file map a sparse set of log tag numbers to tag names.</span></span><br><span class="line"><span class="comment"># This is installed on the device, in /system/etc, and parsed by logcat.</span></span><br><span class="line"><span class="comment"># 此文件最终编译后位于system/etc/event-log-tags文件中，最终由logcat进行解析</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Tag numbers are decimal integers, from 0 to 2^31.  (Let's leave the </span></span><br><span class="line"><span class="comment"># negative values alone for now.)</span></span><br><span class="line"><span class="comment"># Tag编号为十进制,从0到2^31</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Tag names are one or more ASCII letters and numbers or underscores, i.e.</span></span><br><span class="line"><span class="comment"># "[A-Z][a-z][0-9]_".  Do not include spaces or punctuation (the former</span></span><br><span class="line"><span class="comment"># impacts log readability, the latter makes regex searches more annoying).</span></span><br><span class="line"><span class="comment"># Tag名字由字符串和数字组成,为了方便在log中搜索，name中避免使用空格和标点</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Tag numbers and names are separated by whitespace.  Blank lines and lines</span></span><br><span class="line"><span class="comment"># starting with '#' are ignored.</span></span><br><span class="line"><span class="comment"># Tag的编号和名字由一个空格隔开,空行或者以#开头的行将被忽略</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Optionally, after the tag names can be put a description for the value(s)</span></span><br><span class="line"><span class="comment"># of the tag. Description are in the format</span></span><br><span class="line"><span class="comment">#    (&lt;name&gt;|data type[|data unit])</span></span><br><span class="line"><span class="comment"># Multiple values are separated by commas.</span></span><br><span class="line"><span class="comment"># 根据需要,tag names后面可以加上这个tag的values来描述这个tag的打印格式。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 数据类型由下列的数字组成:(如果数字类型时int,则data type用1表示)</span></span><br><span class="line"><span class="comment"># The data type is a number from the following values:</span></span><br><span class="line"><span class="comment"># 1: int</span></span><br><span class="line"><span class="comment"># 2: long</span></span><br><span class="line"><span class="comment"># 3: string</span></span><br><span class="line"><span class="comment"># 4: list</span></span><br><span class="line"><span class="comment"># 5: float</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># data unit 表示数据格式，相当于data的单位：(1表示Number of objects)</span></span><br><span class="line"><span class="comment"># The data unit is a number taken from the following list:</span></span><br><span class="line"><span class="comment"># 1: Number of objects 对象个数</span></span><br><span class="line"><span class="comment"># 2: Number of bytes 对象字节数</span></span><br><span class="line"><span class="comment"># 3: Number of milliseconds 毫秒</span></span><br><span class="line"><span class="comment"># 4: Number of allocations 分配的个数</span></span><br><span class="line"><span class="comment"># 5: Id</span></span><br><span class="line"><span class="comment"># 6: Percent</span></span><br><span class="line"><span class="comment"># s: Number of seconds (monotonic time)</span></span><br><span class="line"><span class="comment"># Default value for data of type int/long is 2 (bytes).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> generate ".java" and ".h" files with integer constants from this file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTE - the range 1000000-2000000 is reserved for partners and others who</span></span><br><span class="line"><span class="comment"># want to define their own log tags without conflicting with the core platform.</span></span><br><span class="line"><span class="comment"># 1000000-2000000的tag number是留给合作厂商或者其他开发者用户扩展用的。</span></span><br></pre></td></tr></table></figure></p>
<p> 根据system/core/logcat/event.logtags中对logtags格式文件的描述，我们取上面的SystemUI中的logtags文件中的一个Event事件为例来说明：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">36000</span> sysui_statusbar_touch (type|<span class="number">1</span>),(x|<span class="number">1</span>),(y|<span class="number">1</span>),(disable1|<span class="number">1</span>),(disable2|<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p> 对应定义<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#    (&lt;name&gt;|data type[|data unit])</span><br></pre></td></tr></table></figure></p>
<p> 则：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tag Number: <span class="number">36000</span></span><br><span class="line">Tag name: sysui_statusbar_touch</span><br><span class="line">value <span class="number">1</span>: name=<span class="string">"type"</span>, data_type=<span class="number">1</span>-&gt;<span class="keyword">int</span></span><br><span class="line">value <span class="number">2</span>: name=<span class="string">"x"</span>, data_type=<span class="number">1</span>-&gt;<span class="keyword">int</span></span><br><span class="line">value <span class="number">3</span>: name=<span class="string">"y"</span>, data_type=<span class="number">1</span>-&gt;<span class="keyword">int</span></span><br><span class="line">value <span class="number">4</span>: name=<span class="string">"disable1"</span>, data_type=<span class="number">1</span>-&gt;<span class="keyword">int</span></span><br><span class="line">value <span class="number">5</span>: name=<span class="string">"disable2"</span>, data_type=<span class="number">1</span>-&gt;<span class="keyword">int</span></span><br></pre></td></tr></table></figure></p>
<p> 接下来看看如何在SystemUI的Java代码中使用,在<br> frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">interceptTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_GESTURES) &#123;</span><br><span class="line">        <span class="keyword">if</span> (event.getActionMasked() != MotionEvent.ACTION_MOVE) &#123;</span><br><span class="line">            EventLog.writeEvent(EventLogTags.SYSUI_STATUSBAR_TOUCH,</span><br><span class="line">                    event.getActionMasked(), (<span class="keyword">int</span>) event.getX(), (<span class="keyword">int</span>) event.getY(),</span><br><span class="line">                    mDisabled1, mDisabled2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p> 可以看到在StatusBar的interceptTouchEvent方法中，将touch事件写入了event log中.</p>
<h2 id="相关功能模块代码"><a href="#相关功能模块代码" class="headerlink" title="相关功能模块代码"></a>相关功能模块代码</h2><p> 本节将从EventLog调用流程来分析相关的关键代码块：</p>
<h3 id="framework模块："><a href="#framework模块：" class="headerlink" title="framework模块："></a>framework模块：</h3><p> • frameworks/base/core/java/android/util/EventLogTags.java //已经被弃用，8.1.0中使用的是EventLog.java<br> • frameworks/base/core/java/android/util/EventLog.java<br>  主要在EventLog.java文件中实现了下列函数供Java侧的各个模块调用：<br>  a)实现writeEvent函数，通过JNI，调用到底层的代码，最终将event写入到/dev/log/events，调用关系如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EventLog.writeEvent() [android.util.EventLog][EventLog.java]</span><br><span class="line">android_util_EventLog_writeEvent_Integer() [libandroid_runtime.so][android_util_EventLog.cpp]</span><br><span class="line">android_bWriteLog() -&gt; __android_log_bwrite() [liblog.so][]</span><br><span class="line">write_to_log(LOG_ID_EVENTS, vec, <span class="number">2</span>) -&gt; __write_to_log_kernel() [liblog.so]</span><br></pre></td></tr></table></figure></p>
<p> b)实现readEvents函数，通过JNI,调用到底层代码, 具体使用场景还不没找,提供了方法来读取对应type的eventlog<br> c)实现getTagName函数，通过给出的ID，返回Tag的名称，主要通过在system/etc/event-log-tags文件里面进行查找实现，供Java侧其他模块调用<br> d)实现getTagCode函数，通过给出的Tag名称，返回Tag的ID，主要通过在system/etc/event-log-tags文件里面进行查找实现，供Java侧其他模块调用<br> e)实现内部静态类Event，这个是8.1.0之前的老版本的EventLog的实现.暂不关注.</p>
<h3 id="JNI-模块："><a href="#JNI-模块：" class="headerlink" title="JNI 模块："></a>JNI 模块：</h3><p> • frameworks/base/core/jni/android_util_EventLog.cpp<br> 实现了EventLog.java中的writeEvent和readEvent函数.在writeEvent函数中调用android_log_event_list类的write方法.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * In class android.util.EventLog:</span></span><br><span class="line"><span class="comment"> *  static native int writeEvent(int tag, int value)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">android_util_EventLog_writeEvent_Integer</span><span class="params">(JNIEnv* env UNUSED,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                     jobject clazz UNUSED,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                     jint tag, jint value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">android_log_event_list <span class="title">ctx</span><span class="params">(tag)</span></span>;</span><br><span class="line">    ctx &lt;&lt; (<span class="keyword">int32_t</span>)value;</span><br><span class="line">    <span class="keyword">return</span> ctx.write();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> framework模块的代码还有:<br> frameworks/base/core/java/com/android/internal/logging/MetricsLogger.java<br> frameworks/base/core/java/android/metrics/MetricsReader.java<br> 以sysui_multi_action事件分析为例</p>
<h3 id="liblog模块："><a href="#liblog模块：" class="headerlink" title="liblog模块："></a>liblog模块：</h3><p> • system/core/liblog/include/log/log_event_list.h //定义了android_log_event_list类<br> • system/core/liblog/log_event_list.c //实现了android_log_event_list类的相关方法<br> • system/core/liblog/event_tag_map.cpp<br> • system/core/liblog/logger_write.c<br> liblog模块,在log_event_list.h中android_log_event_list.h中，初始化后，被&lt;&lt;赋值，执行android_log_write_int32函数，android_log_write_int32的实现在log_event_list.c，接着执行ctx.write().<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write</span><span class="params">(<span class="keyword">log_id_t</span> id = LOG_ID_EVENTS)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* facilitate -EBUSY retry */</span></span><br><span class="line">  <span class="keyword">if</span> ((ret == -EBUSY) || (ret &gt; <span class="number">0</span>)) ret = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> retval = android_log_write_list(ctx, id);</span><br><span class="line">  <span class="comment">/* existing errors trump transmission errors */</span></span><br><span class="line">  <span class="keyword">if</span> (!ret) ret = retval;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 在log_event_list.c 中执行android_log_write_list函数，如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Logs the list of elements to the event log.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">LIBLOG_ABI_PUBLIC <span class="keyword">int</span> <span class="title">android_log_write_list</span><span class="params">(android_log_context ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">log_id_t</span> id)</span> </span>&#123;</span><br><span class="line">  android_log_context_internal* context;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* msg;</span><br><span class="line">  <span class="keyword">ssize_t</span> len;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((id != LOG_ID_EVENTS) &amp;&amp; (id != LOG_ID_SECURITY)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  context = (android_log_context_internal*)ctx;</span><br><span class="line">  <span class="keyword">if</span> (!context || (kAndroidLoggerWrite != context-&gt;read_write_flag)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EBADF;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (context-&gt;list_nest_depth) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EIO;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* NB: if there was overflow, then log is truncated. Nothing reported */</span></span><br><span class="line">  context-&gt;storage[<span class="number">1</span>] = context-&gt;count[<span class="number">0</span>];</span><br><span class="line">  len = context-&gt;len = context-&gt;pos;</span><br><span class="line">  msg = (<span class="keyword">const</span> <span class="keyword">char</span>*)context-&gt;storage;</span><br><span class="line">  <span class="comment">/* it's not a list */</span></span><br><span class="line">  <span class="keyword">if</span> (context-&gt;count[<span class="number">0</span>] &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">    len -= <span class="keyword">sizeof</span>(<span class="keyword">uint8_t</span>) + <span class="keyword">sizeof</span>(<span class="keyword">uint8_t</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      len = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    msg += <span class="keyword">sizeof</span>(<span class="keyword">uint8_t</span>) + <span class="keyword">sizeof</span>(<span class="keyword">uint8_t</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (id == LOG_ID_EVENTS)</span><br><span class="line">             ? __android_log_bwrite(context-&gt;tag, msg, len)</span><br><span class="line">             : __android_log_security_bwrite(context-&gt;tag, msg, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 最后执行__android_log_bwrite函数，在logger_write.c中__android_log_bwrite函数如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LIBLOG_ABI_PUBLIC <span class="keyword">int</span> __android_log_bwrite(<span class="keyword">int32_t</span> tag, <span class="keyword">const</span> <span class="keyword">void</span>* payload,</span><br><span class="line">                                           <span class="keyword">size_t</span> len) &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vec</span>[2];</span></span><br><span class="line"></span><br><span class="line">  vec[<span class="number">0</span>].iov_base = &amp;tag;</span><br><span class="line">  vec[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span>(tag);</span><br><span class="line">  vec[<span class="number">1</span>].iov_base = (<span class="keyword">void</span>*)payload;</span><br><span class="line">  vec[<span class="number">1</span>].iov_len = len;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> write_to_log(LOG_ID_EVENTS, vec, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> write_to_log将此event事件写入dev/log/event节点中.<br> 可以继续追踪write_to_log函数,在logger_write.c中<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __write_to_log_init(<span class="keyword">log_id_t</span>, struct iovec* vec, <span class="keyword">size_t</span> nr);</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*write_to_log)</span><span class="params">(<span class="keyword">log_id_t</span>, struct iovec* vec,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">size_t</span> nr)</span> </span>= __write_to_log_init;</span><br></pre></td></tr></table></figure></p>
<p> 则看__write_to_log_init函数，如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __write_to_log_init(<span class="keyword">log_id_t</span> log_id, struct iovec* vec, <span class="keyword">size_t</span> nr) &#123;</span><br><span class="line">  __android_log_lock();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write_to_log == __write_to_log_init) &#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = __write_to_log_initialize();</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      __android_log_unlock();</span><br><span class="line">      <span class="keyword">if</span> (!list_empty(&amp;__android_log_persist_write)) &#123;</span><br><span class="line">        __write_to_log_daemon(log_id, vec, nr);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    write_to_log = __write_to_log_daemon;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  __android_log_unlock();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> write_to_log(log_id, vec, nr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 追的有点远了，打住，回到eventlog的正题.</p>
<p> 从上面的流程来看，在Java代码中相应函数内对EventLog进行打点,最后通过JNI回调和传参，就可以将Eventlog写入/dev/log/event节点了.//等等，8.1.0好像不是写入这个节点…<br> 在这个过程中，我们用到了一类文件<em>.logtags，从最还是我们看到了，这类文件主要用来用固定的格式来定义个EventLog事件，然后在Java文件中我们就可以直接使用定义好的事件名称和函数个数来打点Event事件.至于Java侧如何能够成功的调用Eventlog，大体流程是，Android代码在编译的过程中，build模块的一些脚本会自动的将相应模块的</em>.logtags文件中的Event事件收集汇总到system/etc/event-log-tags文件中，同时也会将对应的*.logtags文件转换成一个EventLogTags.java文件看下面的分析</p>
<h3 id="system中logd模块："><a href="#system中logd模块：" class="headerlink" title="system中logd模块："></a>system中logd模块：</h3><p> • system/core/logd/LogTags.cpp<br> • system/core/logd/LogTags.h<br>  读取system/etc/event-log-tags文件</p>
<h3 id="build模块："><a href="#build模块：" class="headerlink" title="build模块："></a>build模块：</h3><p> • build/tools/java-event-log-tags.py //将对应的*.logtags文件转换为java文件<br> • build/tools/event_log_tags.py   //输出event-log-tags文件<br> • build/tools/merge-event-log-tags.py //将生成的多个event-log-tags文件，整合到一个event-log-tags文件中<br>  build模块中的脚本，从代码来看干了两件事情：<br>  a)负责将各个模块中的EventLogTags.logtags文件转化为相对应的java文件，并输出到out/target/common/obj/JAVA_LIBRARIES 对应的目录中.<br>  b)负责将各个模块中的*.logtags文件中的事件，进行收集，并输出到out/…/system/etc/event-log-tags文件中</p>
<p>  对于生成EventLogTags.java文件，我们还是以上面的SystemUI模块为例，SystemUI模块中有一个EventLogTags.logtags文件<br>  frameworks/base/packages/SystemUI/src/com/android/systemui/EventLogTags.logtags，我们在单编完SystemUI之后，到out/target/common/obj/JAVA_LIBRARIES目录查找systemui相关的lib库文件,找到<br>  out/target/common/obj/JAVA_LIBRARIES/SystemUI-tags_intermediates/src/src/com/android/systemui/EventLogTags.java<br>  下面我们从此文件中抽出我们上面以SystemUI为例时的sysui_statusbar_touch事件在此java文件中的结果如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This file is auto-generated.  DO NOT MODIFY.</span></span><br><span class="line"><span class="comment"> * Source file: frameworks/base/packages/SystemUI/src/com/android/systemui/EventLogTags.logtags</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.android.systemui;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventLogTags</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">EventLogTags</span><span class="params">()</span> </span>&#123; &#125;  <span class="comment">// don't instantiate</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">/** 36010 sysui_panelbar_touch (type|1),(x|1),(y|1),(enabled|1) */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SYSUI_PANELBAR_TOUCH = <span class="number">36010</span>;</span><br><span class="line">  ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeSysuiPanelbarTouch</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> enabled)</span> </span>&#123;</span><br><span class="line">    android.util.EventLog.writeEvent(SYSUI_PANELBAR_TOUCH, type, x, y, enabled);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure></p>
<p> 可以看出多了一个静态常量和一个API可以调用，所以在源码里面可以这样调用（android源码的做法）：<br>EventLog.writeEvent(EventLogTags.AM_SERVICE_CRASHED_TOO_MUCH,<br>                            sr.crashCount, sr.shortName, app.pid);<br>这里只是用了AM_SERVICE_CRASHED_TOO_MUCH这个常量而没有调专用API，或者这样用（测试可以编译通过）：<br>EventLog.writeAmServiceCrashedTooMuch(sr.crashCount, sr.shortName, app.pid);</p>
<h3 id="EventLog在解Bug中的应用"><a href="#EventLog在解Bug中的应用" class="headerlink" title="EventLog在解Bug中的应用"></a>EventLog在解Bug中的应用</h3><p> 下面列举tag可能使用的部分场景：<br>    am_low_memory：位于AMS.killAllBackgroundProcesses或者AMS.appDiedLocked，记录当前Lru进程队列长度。<br>    am_pss：位于AMS.recordPssSampleLocked(<br>    am_meminfo：位于AMS.dumpApplicationMemoryUsage<br>    am_proc_start:位于AMS.startProcessLocked，启动进程<br>    am_proc_bound:位于AMS.attachApplicationLocked<br>    am_kill: 位于ProcessRecord.kill，杀掉进程<br>    am_anr: 位于AMS.appNotResponding<br>    am_crash:位于AMS.handleApplicationCrashInner<br>    am_wtf:位于AMS.handleApplicationWtf<br>    am_activity_launch_time：位于ActivityRecord.reportLaunchTimeLocked()，后面两个参数分别是thisTime和 totalTime.<br>    am_activity_fully_drawn_time:位于ActivityRecord.reportFullyDrawnLocked, 后面两个参数分别是thisTime和 totalTime<br>    am_broadcast_discard_filter:位于BroadcastQueue.logBroadcastReceiverDiscardLocked<br>    am_broadcast_discard_app:位于BroadcastQueue.logBroadcastReceiverDiscardLocked</p>
<p>Activity生命周期相关的方法:<br>    am_on_resume_called: 位于AT.performResumeActivity<br>    am_on_paused_called: 位于AT.performPauseActivity, performDestroyActivity<br>    am_resume_activity: 位于AS.resumeTopActivityInnerLocked<br>    am_pause_activity: 位于AS.startPausingLocked<br>    am_finish_activity: 位于AS.finishActivityLocked, removeHistoryRecordsForAppLocked<br>    am_destroy_activity: 位于AS.destroyActivityLocked<br>    am_focused_activity: 位于AMS.setFocusedActivityLocked, clearFocusedActivity<br>    am_restart_activity: 位于ASS.realStartActivityLocked<br>    am_create_activity: 位于ASS.startActivityUncheckedLocked<br>    am_new_intent: 位于ASS.startActivityUncheckedLocked<br>    am_task_to_front: 位于AS.moveTaskToFrontLocked</p>
<p>下面列举tag可能使用的部分场景：<br>    power_sleep_requested: 位于PMS.goToSleepNoUpdateLocked<br>    power_screen_state:位于Notifer.handleEarlyInteractiveChange, handleLateInteractiveChange</p>
<p>   battery_level: [19,3660,352] //剩余电量19%, 电池电压3.66v, 电池温度35.2℃<br>   power_screen_state: [0,3,0,0] // 灭屏状态(0), 屏幕超时(3). 当然还有其他设备管理策略(1),其他理由都为用户行为(2)<br>   power_screen_state: [1,0,0,0] // 亮屏状态(1)</p>
<p>补充：<br>am_proc_start (User|1|5),(PID|1|5),(UID|1|5),(Process Name|3),(Type|3),(Component|3)<br>am_proc_start:[0,9227,10002,com.android.browser,contentprovider,com.android.browser/.provider.BrowserProvider2]<br>–&gt; (User|1|5) ==&gt; 名字为User, 数据类型为1，数据单位为5）<br>数据类型：1: int、2: long、3: string、4: list<br>数据单位：1: Number of objects(对象个数)、2: Number of bytes(字节数)、3: Number of milliseconds(毫秒)、4: Number of allocations(分配个数)、5: Id、6: Percent(百分比)<br>–&gt; 进程启动: UserId=0, pid=9227, uid=10002, ProcessName=com.android.browser, 数据类型=ContentProvider, 组件=com.android.browser/.provider.BrowserProvider2</p>
<h3 id="event-log使用小技巧"><a href="#event-log使用小技巧" class="headerlink" title="event log使用小技巧"></a>event log使用小技巧</h3><p>• 通过Tag ID来过滤event log<br> adb logcat -t 524292 -b events //打印出所有sysui_multi_action事件的event log<br> adb logcat -v threadtime -t 524292 -b events<br>• 通过Tag name来过滤event log<br> adb logcat -b events | grep -rn sysui_multi_action //打印出所有sysui_multi_action事件的event log<br> adb logcat -v threadtime -b events | grep -rn sysui_multi_action</p>
<p><strong><a href="https://github.com/EricChows/logcat/blob/master/8.1.0-event-log/system/etc/event-log-tags" target="_blank" rel="noopener">在Android中所有已经定义了的Eventlog事件可以在这里查看</a></strong><br> <a href="https://github.com/EricChows/logcat/tree/master/8.1.0-event-log" target="_blank" rel="noopener">Eventlog相关的文件可以到这里查看</a></p>
<p> 如下待完成补充：<br> C/C++模块中EventLog的使用，<br> • system/core/logcat/event.logtags</p>
<p> 思考：Event log的优势在哪里？其实Event log要实现的功能，main log其实也是可以实现的.<br> 我的回答：对不同log划分了不同缓冲区后，就不用担心log被覆盖掉，关键的event log不用担心main太多被冲掉.</p>
<p>参考阅读：<br><a href="https://blog.csdn.net/yaowei514473839/article/details/53513435" target="_blank" rel="noopener">Android event日志打印原理</a><br><a href="https://blog.csdn.net/darkengine/article/details/8477502" target="_blank" rel="noopener">【framework】EventLog分析</a></p>
<h1 id="Android中其他log分析"><a href="#Android中其他log分析" class="headerlink" title="Android中其他log分析"></a>Android中其他log分析</h1><h1 id="LINUX-KERNEL源代码目录结构"><a href="#LINUX-KERNEL源代码目录结构" class="headerlink" title="LINUX KERNEL源代码目录结构"></a>LINUX KERNEL源代码目录结构</h1><p>/arch：硬件体系结构相关的代码，每种平台占一个相应的目录<br>/drivers：设备驱动程序，每个不同的驱动占用一个子目录<br>/fs：文件系统，包含所有的文件系统代码和各种类型的文件操作代码，它的每一个子目录支持一个文件系统<br>/include：包括编译核心所需要的大部分头文件。与平台无关的头文件在 include/linux 子目录下，与intel cpu 相关的头文件在 include/asm-i386<br>          子目录下，而 include/scsi 目录则是有关scsi 设备的头文件目录<br>init：这个目录包含核心的初始化代码（不是系统的引导代码），包含两个文件 main.c 和 Version.c，这是研究核心如何工作的好起点之一<br>/ipc：核心的进程间通讯的代码<br>/kernel：主要的核心代码，此目录下的文件是内核的最核心部分，包括进程调度、定时器等，实现了大多数Linux 系统的内核函数，其中重要的<br>         文件尾 sched.c ；同样，和体系结构相关的代码在 arch/*/kernel 中<br>/lib：放置核心库代码<br>/mm：这个目录包括所有独立于 CPU 体系机构的内存管理代码，如页式存储管理内存的分配和释放等；而合体系结构相关的内存管理代码则<br>     位于 arch/*/mm<br>/net：网络相关代码，实现了各种常见的网络协议<br>/scripts：描述文件，脚本，用于对核心的配置<br>/security：主要是一个SELinux 的模块<br>/sound：常用音频设备的驱动程序等<br>/usr：实现了一个 cpio<br>/block：部分块设备驱动程序<br>/crypto：常用加密和散列算法（如AES、SHA等），以及一些压缩和CRC 校验算法<br>/Documentation：一套关于内核部分的调用解释和注释用的英文文档</p>
<p>根目录下几个文件：<br>COPYING：GPL 版权申明，对具有GPL 版权的源代码改动而形成的程序，具有使用GPL 发表的义务，如公开源代码<br>CREDITS：光荣榜。对Linux 做出过很大贡献的一些人的信息<br>Kbuild：是编译内核的软件环境，它泛指构建一个完全并能够运行Linux 内核所需要的一切资源。这些资源包含构建程序、脚本、中间件、配置<br>        文件和Makefile<br>MAINTAINERS：维护人员列表，对当前版本的内核部分都有谁负责<br>Makefile：第一个Makefile 文件。用来组织内核的各模块，记录了各模块相互之间的联系和依托关系，编译时使用；仔细阅读各子目录下的<br>          Makefile文件对弄清各个文件之间的联系和依托关系很有帮助<br>ReadMe：核心以及编译配置方法简单介绍取模<br>REPORING-BUGS：有关报告 Bug 的一些内容</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://blog.csdn.net/luoshengyang/article/details/8923485" target="_blank" rel="noopener">那两年炼就的Android内功修养</a><br><a href="https://blog.csdn.net/luoshengyang/article/details/6581828" target="_blank" rel="noopener">浅谈Android系统开发中LOG的使用</a><br><a href="https://blog.csdn.net/luoshengyang/article/details/6595744" target="_blank" rel="noopener">Android日志系统驱动程序Logger源代码分析</a><br><a href="https://blog.csdn.net/luoshengyang/article/details/6598703" target="_blank" rel="noopener">Android应用程序框架层和系统运行库层日志系统源代码分析</a><br><a href="https://blog.csdn.net/luoshengyang/article/details/6606957" target="_blank" rel="noopener">Android日志系统Logcat源代码简要分析</a></p>
<p><a href="https://blog.csdn.net/armwind/article/details/52166139" target="_blank" rel="noopener">misc设备</a> 杂项设备<br>[mutex互斥锁]<br><a href="https://blog.csdn.net/koffuxu/article/details/53997348" target="_blank" rel="noopener">Android L日志系统2——JavaAPI与liblog</a><br><a href="https://www.cnblogs.com/palance/p/5247093.html" target="_blank" rel="noopener">Android6的Logger日志系统</a><br><a href="https://zhuanlan.zhihu.com/p/24372024" target="_blank" rel="noopener">Android6.0 Log的工作机制</a><br><a href="https://blog.csdn.net/shusuanly/article/details/80577306" target="_blank" rel="noopener">Android O 配置logcatd日志系统</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android-Log/" rel="tag"># Android Log</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Android8-0-charging-icon-cannot-show/" rel="next" title="Android8.0充电图标不显示">
                <i class="fa fa-chevron-left"></i> Android8.0充电图标不显示
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Android-Window-Mechanism/" rel="prev" title="Android中Window机制">
                Android中Window机制 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div id="gitalk-container"></div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/myapple.jpg"
                alt="Eric Chows" />
            
              <p class="site-author-name" itemprop="name">Eric Chows</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">69</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">77</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/ericchows" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:xnzds2008@163.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://plus.google.com" target="_blank" title="Google">
                    
                      <i class="fa fa-fw fa-google"></i>Google</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com" target="_blank" title="Twitter">
                    
                      <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.facebook.com" target="_blank" title="FB Page">
                    
                      <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://vk.com" target="_blank" title="VK Group">
                    
                      <i class="fa fa-fw fa-vk"></i>VK Group</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://stackoverflow.com/users/8872810/eric" target="_blank" title="StackOverflow">
                    
                      <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://youtube.com" target="_blank" title="YouTube">
                    
                      <i class="fa fa-fw fa-youtube"></i>YouTube</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://instagram.com" target="_blank" title="Instagram">
                    
                      <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="skype" target="_blank" title="Skype">
                    
                      <i class="fa fa-fw fa-skype"></i>Skype</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="/images/wechat.jpg" target="_blank" title="Wechat">
                    
                      <i class="fa fa-fw fa-globe"></i>Wechat</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://blog.csdn.net/Cxiaolinxiaozi" target="_blank" title="CSDN">
                    
                      <i class="fa fa-fw fa-globe"></i>CSDN</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Log的使用"><span class="nav-number">2.</span> <span class="nav-text">Log的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#内核态Kernel-log的使用"><span class="nav-number">2.1.</span> <span class="nav-text">内核态Kernel log的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#printk的使用"><span class="nav-number">2.1.1.</span> <span class="nav-text">printk的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#printk源码分析"><span class="nav-number">2.1.2.</span> <span class="nav-text">printk源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dmesg-log"><span class="nav-number">2.1.3.</span> <span class="nav-text">dmesg log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#串口log"><span class="nav-number">2.1.4.</span> <span class="nav-text">串口log</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用户态Log的使用"><span class="nav-number">2.2.</span> <span class="nav-text">用户态Log的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#C-C-模块Log的使用"><span class="nav-number">2.2.1.</span> <span class="nav-text">C/C++模块Log的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java模块Log的使用"><span class="nav-number">2.2.2.</span> <span class="nav-text">Java模块Log的使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#logcat的使用"><span class="nav-number">2.3.</span> <span class="nav-text">logcat的使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Framework中Log功能解析"><span class="nav-number">3.</span> <span class="nav-text">Framework中Log功能解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#main-system-radio-log"><span class="nav-number">3.1.</span> <span class="nav-text">main/system/radio log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Event-log"><span class="nav-number">3.2.</span> <span class="nav-text">Event log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#crash-log"><span class="nav-number">3.3.</span> <span class="nav-text">crash log</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JNI中log功能解析"><span class="nav-number">4.</span> <span class="nav-text">JNI中log功能解析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#运行时库层liblog模块log功能解析"><span class="nav-number">5.</span> <span class="nav-text">运行时库层liblog模块log功能解析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#logd模块功能解析"><span class="nav-number">6.</span> <span class="nav-text">logd模块功能解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#logd-进程的启动"><span class="nav-number">6.1.</span> <span class="nav-text">logd 进程的启动</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Logcat源码解析"><span class="nav-number">7.</span> <span class="nav-text">Logcat源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模块文件分析"><span class="nav-number">7.1.</span> <span class="nav-text">模块文件分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Logwrapper-模块解析"><span class="nav-number">8.</span> <span class="nav-text">Logwrapper 模块解析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Logger-驱动模块解析"><span class="nav-number">9.</span> <span class="nav-text">Logger 驱动模块解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Logger系统数据结构"><span class="nav-number">9.1.</span> <span class="nav-text">Logger系统数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Logger模块的初始化过程分析"><span class="nav-number">9.2.</span> <span class="nav-text">Logger模块的初始化过程分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志系统读取"><span class="nav-number">9.3.</span> <span class="nav-text">日志系统读取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志系统写入"><span class="nav-number">9.4.</span> <span class="nav-text">日志系统写入</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Eventlog解析"><span class="nav-number">10.</span> <span class="nav-text">Eventlog解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Eventlog的使用"><span class="nav-number">10.1.</span> <span class="nav-text">Eventlog的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关功能模块代码"><span class="nav-number">10.2.</span> <span class="nav-text">相关功能模块代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#framework模块："><span class="nav-number">10.2.1.</span> <span class="nav-text">framework模块：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-模块："><span class="nav-number">10.2.2.</span> <span class="nav-text">JNI 模块：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#liblog模块："><span class="nav-number">10.2.3.</span> <span class="nav-text">liblog模块：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#system中logd模块："><span class="nav-number">10.2.4.</span> <span class="nav-text">system中logd模块：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#build模块："><span class="nav-number">10.2.5.</span> <span class="nav-text">build模块：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EventLog在解Bug中的应用"><span class="nav-number">10.2.6.</span> <span class="nav-text">EventLog在解Bug中的应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#event-log使用小技巧"><span class="nav-number">10.2.7.</span> <span class="nav-text">event log使用小技巧</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Android中其他log分析"><span class="nav-number">11.</span> <span class="nav-text">Android中其他log分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LINUX-KERNEL源代码目录结构"><span class="nav-number">12.</span> <span class="nav-text">LINUX KERNEL源代码目录结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">13.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">EricChows</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1274018749&web_id=1274018749" language="JavaScript"></script>
  </div>



        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   <script type="text/javascript">
		var gitalk = new Gitalk({
		  clientID: '2f039a8ed54186479946',
		  clientSecret: 'bc88282455b50fbc8c5d9502d17621a4f9e48d18',
		  repo: 'myblog-comment',
		  owner: 'EricChows',
		  admin: ['EricChows'],
		  id: location.pathname,
		  distractionFreeMode: 'true'
		})
		gitalk.render('gitalk-container')           
       </script>


  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("ANlC6pJEdxOLHAcDbFuHuXrF-gzGzoHsz", "tNpAWjkmbhhKnsB3bcDooRrl");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script>


  

</body>
</html>
